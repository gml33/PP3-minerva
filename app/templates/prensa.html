{% extends 'base.html' %}
{% load static %}

{% block title %}Panel de Prensa{% endblock %}

{% block content %}

<style>
    .card.h-100 {
        height: 300px;
    }

    .card.h-100 img {
        object-fit: contain;
        height: 150px;
        width: 100%;
    }
    
    .nav-tabs .nav-link {
        font-weight: 500;
    }
    
    .btn-group-actions {
        gap: 8px;
    }
    
    .osint-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .osint-card:hover {
        transform: translateY(-5px);
    }
    
    .pagination {
        margin-bottom: 0;
    }
    
    .page-link {
        color: #0d6efd;
    }
    
    .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
</style>

{% if busquedas_pendientes %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>¡Atención!</strong> Hay {{ busquedas_pendientes }} búsqueda(s) pendiente(s) que requieren atención.
    <a href="{% url 'lista_busquedas' %}" class="alert-link">Ver búsquedas pendientes</a>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
</div>
{% endif %}

{% if solicitudes_pendientes %}
<div class="alert alert-warning" role="alert">
    <strong>Solicitud de información pendiente:</strong> Hay {{ solicitudes_pendientes }} solicitud{{ solicitudes_pendientes|pluralize:'es' }} esperando respuesta.
    <a href="{% url 'solicitudes_info_list' %}" class="alert-link">Ir a las solicitudes</a>
</div>
{% endif %}

<h1 class="mb-4">Panel de Prensa</h1>

<ul class="nav nav-tabs mb-4" id="categoriasTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="diarios-tab" data-bs-toggle="tab" data-bs-target="#diarios" type="button" role="tab" aria-controls="diarios" aria-selected="true">
            Diarios Digitales
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="redes-tab" data-bs-toggle="tab" data-bs-target="#redes" type="button" role="tab" aria-controls="redes" aria-selected="false">
            Redes Sociales
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="osint-tab" data-bs-toggle="tab" data-bs-target="#osint" type="button" role="tab" aria-controls="osint" aria-selected="false">
            OSINT
        </button>
    </li>
</ul>

<div class="tab-content" id="categoriasTabsContent">
    
    <div class="tab-pane fade show active" id="diarios" role="tabpanel" aria-labelledby="diarios-tab">
        <div id="cards-diarios" class="row">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando diarios...</span>
                </div>
                <p class="mt-2">Cargando diarios digitales...</p>
            </div>
        </div>

        <div class="card mb-4 mt-4">
            <div class="card-header">Agregar Link de Interés</div>
            <div class="card-body">
                <form id="formulario-link">
                    <div class="mb-3">
                        <label for="url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="url" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Agregar Link</button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Mis Links Cargados</span>
                <span class="badge bg-primary" id="total-links-count">0</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col">
                        <label>Desde:</label>
                        <input type="date" id="fecha_desde" class="form-control">
                    </div>
                    <div class="col">
                        <label>Hasta:</label>
                        <input type="date" id="fecha_hasta" class="form-control">
                    </div>
                    <div class="col">
                        <label>Diario:</label>
                        <select id="diario_filtro" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col d-flex align-items-end">
                        <button class="btn btn-secondary w-100" onclick="cargarLinks(1)">Filtrar</button>
                    </div>
                </div>

                <table class="table table-striped" id="tabla-links">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Fecha</th>
                            <th>Diario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <nav aria-label="Paginación de links">
                    <ul class="pagination justify-content-center" id="pagination-links"></ul>
                </nav>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="redes" role="tabpanel" aria-labelledby="redes-tab">
        <div id="cards-redes" class="row mb-4">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando redes sociales...</span>
                </div>
                <p class="mt-2">Cargando redes sociales...</p>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Agregar Link de Red Social</div>
            <div class="card-body">
                <form id="formulario-link-redes">
                    <div class="mb-3">
                        <label for="red_url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="red_url" required>
                    </div>
                    <div class="mb-3">
                        <label for="red_social_select_form" class="form-label">Red social</label>
                        <select id="red_social_select_form" class="form-select">
                            <option value="">Detectar automáticamente</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Agregar Link</button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Mis Links de Redes Sociales</span>
                <span class="badge bg-primary" id="total-redes-count">0</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col">
                        <label>Desde:</label>
                        <input type="date" id="red_fecha_desde" class="form-control">
                    </div>
                    <div class="col">
                        <label>Hasta:</label>
                        <input type="date" id="red_fecha_hasta" class="form-control">
                    </div>
                    <div class="col">
                        <label>Red social:</label>
                        <select id="red_social_filtro" class="form-select">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col d-flex align-items-end">
                        <button type="button" class="btn btn-secondary w-100" onclick="cargarLinksRedes(1)">Filtrar</button>
                    </div>
                </div>

                <table class="table table-striped" id="tabla-links-redes">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Fecha</th>
                            <th>Red social</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <nav aria-label="Paginación de links de redes">
                    <ul class="pagination justify-content-center" id="pagination-redes"></ul>
                </nav>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="osint" role="tabpanel" aria-labelledby="osint-tab">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Herramientas OSINT</h4>
            {% if user.is_staff or user.is_superuser %}
            <a class="btn btn-primary" href="{% url 'crear_herramienta_osint' %}">Agregar herramienta</a>
            {% endif %}
        </div>
        
        {% if herramientas_osint %}
        <div class="row">
            {% for herramienta in herramientas_osint %}
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 osint-card shadow-sm">
                    <div class="card-body d-flex flex-column text-center">
                        <div class="mb-3">
                            {% if herramienta.logo %}
                                <img src="{{ herramienta.logo.url }}" alt="{{ herramienta.nombre }}" 
                                    class="img-fluid rounded" style="max-height: 80px; max-width: 100%;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto" 
                                    style="width: 100px; height: 80px;">
                                    <span class="text-muted small">{{ herramienta.nombre }}</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <h6 class="card-title mb-2">{{ herramienta.nombre }}</h6>
                        
                        <span class="badge {% if herramienta.tipo == 'gratuito' %}bg-success{% else %}bg-warning{% endif %} mb-2">
                            {{ herramienta.get_tipo_display }}
                        </span>
                        
                        {% if herramienta.descripcion %}
                        <p class="card-text small text-muted flex-grow-1 mb-3">
                            {{ herramienta.descripcion|truncatewords:15 }}
                        </p>
                        {% endif %}
                        
                        <a href="{{ herramienta.url }}" class="btn btn-primary mt-auto" target="_blank" rel="noopener">
                            Visitar
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="alert alert-info">
                Todavía no se cargaron herramientas OSINT. 
                {% if user.is_staff or user.is_superuser %}
                <a href="{% url 'crear_herramienta_osint' %}" class="alert-link">Agregar la primera herramienta</a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEditar">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel">Editar Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editarId">
                    <input type="hidden" id="editarTipo">
                    <div class="mb-3">
                        <label for="editarUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="editarUrl" required>
                    </div>
                    <div class="mb-3" id="editarDiarioGroup">
                        <label for="editarDiario" class="form-label">Diario Digital</label>
                        <select id="editarDiario" class="form-select">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                    <div class="mb-3 d-none" id="editarRedSocialGroup">
                        <label for="editarRedSocial" class="form-label">Red Social</label>
                        <select id="editarRedSocial" class="form-select">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBody">Mensaje aquí</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Cerrar"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let diariosDisponibles = [];
    let redesDisponibles = [];
    let currentPageLinks = 1;
    let currentPageRedes = 1;
    const itemsPerPage = 10;

    // Función para crear una card
    function crearCard(item) {
        const card = document.createElement("div");
        card.className = "col-md-3 mb-3";
        const logo = item.logo_url || '/static/img/default_logo.png';
        card.innerHTML = `
            <div class="card h-100">
                <img src="${logo}" class="card-img-top" alt="${item.nombre}" 
                    style="object-fit: contain; height: 150px; width: 100%; padding: 10px;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${item.nombre}</h5>
                    <a href="${item.url_principal}" class="btn btn-primary mt-auto" target="_blank">Visitar</a>
                </div>
            </div>`;
        return card;
    }

    // Función para mostrar mensaje de "sin registros"
    function mostrarSinRegistros(container) {
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle"></i>
                    <p class="mb-0">No hay registros disponibles en esta categoría.</p>
                </div>
            </div>`;
    }

    // Función para generar la paginación
    function generarPaginacion(totalItems, currentPage, containerId, callback) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const paginationContainer = document.getElementById(containerId);
        
        if (totalPages <= 1) {
            if (paginationContainer) paginationContainer.innerHTML = '';
            return;
        }

        let paginationHTML = '';
        
        // Botón anterior
        if (currentPage > 1) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="${callback}(${currentPage - 1}); return false;">
                        &laquo; Anterior
                    </a>
                </li>`;
        }

        // Páginas
        const maxPagesToShow = 5;
        let startPage, endPage;

        if (totalPages <= maxPagesToShow) {
            startPage = 1;
            endPage = totalPages;
        } else {
            startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            endPage = Math.min(totalPages, currentPage + Math.floor(maxPagesToShow / 2));

            if (startPage === 1) {
                endPage = maxPagesToShow;
            } else if (endPage === totalPages) {
                startPage = totalPages - maxPagesToShow + 1;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>`;
            } else {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="${callback}(${i}); return false;">${i}</a>
                    </li>`;
            }
        }

        // Botón siguiente
        if (currentPage < totalPages) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="${callback}(${currentPage + 1}); return false;">
                        Siguiente &raquo;
                    </a>
                </li>`;
        }

        if (paginationContainer) {
            paginationContainer.innerHTML = `<ul class="pagination justify-content-center">${paginationHTML}</ul>`;
        }
    }

    // Función para cargar diarios
    async function cargarDiarios() {
        const container = document.getElementById("cards-diarios");
        const select = document.getElementById("editarDiario");
        const filtroSelect = document.getElementById("diario_filtro");

        // Limpiar contenedores
        if (container) {
            container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando diarios...</span></div><p class="mt-2">Cargando diarios digitales...</p></div>';
        }
        
        if (select) {
            select.innerHTML = '<option value="">Sin asignar</option>';
        }
        if (filtroSelect) {
            filtroSelect.innerHTML = '<option value="">Todos</option>';
        }

        try {
            const res = await fetch("/api/diarios/");
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            
            diariosDisponibles = await res.json();

            // Limpiar container después de cargar
            if (container) {
                container.innerHTML = "";

                if (diariosDisponibles.length === 0) {
                    mostrarSinRegistros(container);
                } else {
                    diariosDisponibles.forEach((diario) => {
                        container.appendChild(crearCard(diario));
                    });
                }
            }

            // Agregar opciones a los selects
            if (select) {
                diariosDisponibles.forEach((diario) => {
                    const option = document.createElement("option");
                    option.value = diario.id;
                    option.textContent = diario.nombre;
                    select.appendChild(option);
                });
            }
            if (filtroSelect) {
                diariosDisponibles.forEach((diario) => {
                    const optionFiltro = document.createElement("option");
                    optionFiltro.value = diario.id;
                    optionFiltro.textContent = diario.nombre;
                    filtroSelect.appendChild(optionFiltro);
                });
            }
        } catch (error) {
            console.error("Error cargando diarios:", error);
            if (container) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-danger text-center">Error al cargar los diarios digitales.</div></div>';
            }
            mostrarToast("Error al cargar diarios", "danger");
        }
    }

    // Función para cargar redes sociales
    async function cargarRedes() {
        const container = document.getElementById("cards-redes");
        const select = document.getElementById("editarRedSocial");
        const filtroSelect = document.getElementById("red_social_filtro");
        const formSelect = document.getElementById("red_social_select_form");

        if (!container) return;

        // Mostrar spinner de carga
        container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando redes sociales...</span></div><p class="mt-2">Cargando redes sociales...</p></div>';

        if (select) {
            select.innerHTML = '<option value="">Sin asignar</option>';
        }
        if (filtroSelect) {
            filtroSelect.innerHTML = '<option value="">Todas</option>';
        }
        if (formSelect) {
            formSelect.innerHTML = '<option value="">Detectar automáticamente</option>';
        }

        try {
            const res = await fetch("/api/redes/");
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            
            redesDisponibles = await res.json();

            // Limpiar container después de cargar
            container.innerHTML = "";

            if (redesDisponibles.length === 0) {
                mostrarSinRegistros(container);
            } else {
                redesDisponibles.forEach((red) => {
                    container.appendChild(crearCard(red));
                });
            }

            // Agregar opciones a los selects
            if (select) {
                redesDisponibles.forEach((red) => {
                    const option = document.createElement("option");
                    option.value = red.id;
                    option.textContent = red.nombre;
                    select.appendChild(option);
                });
            }
            if (filtroSelect) {
                redesDisponibles.forEach((red) => {
                    const optionFiltro = document.createElement("option");
                    optionFiltro.value = red.id;
                    optionFiltro.textContent = red.nombre;
                    filtroSelect.appendChild(optionFiltro);
                });
            }
            if (formSelect) {
                redesDisponibles.forEach((red) => {
                    const optionForm = document.createElement("option");
                    optionForm.value = red.id;
                    optionForm.textContent = red.nombre;
                    formSelect.appendChild(optionForm);
                });
            }
        } catch (error) {
            console.error("Error cargando redes sociales:", error);
            container.innerHTML = '<div class="col-12"><div class="alert alert-danger text-center">Error al cargar las redes sociales.</div></div>';
            mostrarToast("Error al cargar redes sociales", "danger");
        }
    }

    // Función para cargar links de diarios - CORREGIDA
    async function cargarLinks(page = 1) {
        currentPageLinks = page;
        const tablaBody = document.querySelector("#tabla-links tbody");
        const paginationContainer = document.getElementById("pagination-links");
        
        if (!tablaBody) {
            console.error("No se encontró la tabla #tabla-links tbody");
            return;
        }
        
        tablaBody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Cargando links...</td></tr>';
        if (paginationContainer) {
            paginationContainer.innerHTML = '';
        }
        
        const fechaDesde = document.getElementById("fecha_desde")?.value || "";
        const fechaHasta = document.getElementById("fecha_hasta")?.value || "";
        const diarioFiltro = document.getElementById("diario_filtro")?.value || "";

        // Construir los parámetros de consulta con paginación
        const params = new URLSearchParams({ 
            page: page,
            page_size: itemsPerPage,
            tipo: 'diario'
        });

        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);
        if (diarioFiltro) params.append('diario_id', diarioFiltro);

        const url = `/api/links/?${params.toString()}`;
        console.log("URL de petición diarios:", url);

        try {
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`Error HTTP: ${res.status} ${res.statusText}`);
            }

            const data = await res.json();
            console.log("Datos recibidos diarios:", data);
            
            // Manejar diferentes estructuras de respuesta
            let links = [];
            let count = 0;
            
            if (Array.isArray(data)) {
                // Si la respuesta es directamente un array
                links = data;
                count = data.length;
                
                // Aplicar paginación manualmente si el backend no lo hace
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, links.length);
                links = links.slice(startIndex, endIndex);
            } else if (data.results && Array.isArray(data.results)) {
                // Si la respuesta tiene formato de paginación estándar
                links = data.results;
                count = data.count || data.results.length;
            } else {
                // Intentar extraer links de diferentes estructuras
                links = data.links || data.data || [];
                count = data.total || data.count || links.length;
            }
            
            console.log("Links procesados diarios:", links.length, "Total:", count);

            document.getElementById("total-links-count").textContent = count;

            tablaBody.innerHTML = "";
            
            if (links.length === 0) {
                tablaBody.innerHTML = '<tr><td colspan="4" class="text-center">No se encontraron links.</td></tr>';
            } else {
                links.forEach(link => {
                    const row = tablaBody.insertRow();
                    
                    const urlText = link.url || 'N/A';
                    const fechaText = link.fecha_creacion ? new Date(link.fecha_creacion).toLocaleDateString() : 'N/A';
                    const diarioText = link.diario_nombre || link.diario || 'N/A';
                    const linkId = link.id || 0;
                    
                    row.innerHTML = `
                        <td><a href="${urlText}" target="_blank" title="${urlText}">${urlText.length > 50 ? urlText.substring(0, 50) + '...' : urlText}</a></td>
                        <td>${fechaText}</td>
                        <td>${diarioText}</td>
                        <td class="btn-group-actions d-flex">
                            <button class="btn btn-sm btn-info me-1" onclick="abrirModalEditar(${linkId}, 'diario')">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarLink(${linkId}, 'diario')">Eliminar</button>
                        </td>
                    `;
                });
            }

            generarPaginacion(count, currentPageLinks, 'pagination-links', 'cargarLinks');

        } catch (error) {
            console.error("Error cargando links de diarios:", error);
            tablaBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los links: ' + error.message + '</td></tr>';
            mostrarToast("Error al cargar links de diarios", "danger");
        }
    }

    // Función para cargar links de redes sociales - CORREGIDA
    async function cargarLinksRedes(page = 1) {
        currentPageRedes = page;
        const tablaBody = document.querySelector("#tabla-links-redes tbody");
        const paginationContainer = document.getElementById("pagination-redes");
        
        if (!tablaBody) {
            console.error("No se encontró la tabla #tabla-links-redes tbody");
            return;
        }
        
        tablaBody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Cargando links...</td></tr>';
        if (paginationContainer) {
            paginationContainer.innerHTML = '';
        }
        
        const fechaDesde = document.getElementById("red_fecha_desde")?.value || "";
        const fechaHasta = document.getElementById("red_fecha_hasta")?.value || "";
        const redSocialFiltro = document.getElementById("red_social_filtro")?.value || "";

        // Construir los parámetros de consulta con paginación
        const params = new URLSearchParams({ 
            page: page,
            page_size: itemsPerPage,
            tipo: 'red_social'
        });

        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);
        if (redSocialFiltro) params.append('red_social_id', redSocialFiltro);

        const url = `/api/links/?${params.toString()}`;
        console.log("URL de petición redes:", url);

        try {
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`Error HTTP: ${res.status} ${res.statusText}`);
            }

            const data = await res.json();
            console.log("Datos recibidos redes:", data);
            
            // Manejar diferentes estructuras de respuesta
            let links = [];
            let count = 0;
            
            if (Array.isArray(data)) {
                // Si la respuesta es directamente un array
                links = data;
                count = data.length;
                
                // Aplicar paginación manualmente si el backend no lo hace
                const startIndex = (page - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, links.length);
                links = links.slice(startIndex, endIndex);
            } else if (data.results && Array.isArray(data.results)) {
                // Si la respuesta tiene formato de paginación estándar
                links = data.results;
                count = data.count || data.results.length;
            } else {
                // Intentar extraer links de diferentes estructuras
                links = data.links || data.data || [];
                count = data.total || data.count || links.length;
            }
            
            console.log("Links procesados redes:", links.length, "Total:", count);

            document.getElementById("total-redes-count").textContent = count;

            tablaBody.innerHTML = "";
            
            if (links.length === 0) {
                tablaBody.innerHTML = '<tr><td colspan="4" class="text-center">No se encontraron links.</td></tr>';
            } else {
                links.forEach(link => {
                    const row = tablaBody.insertRow();
                    
                    const urlText = link.url || 'N/A';
                    const fechaText = link.fecha_creacion ? new Date(link.fecha_creacion).toLocaleDateString() : 'N/A';
                    const redText = link.red_social_nombre || link.red_social || 'N/A';
                    const linkId = link.id || 0;
                    
                    row.innerHTML = `
                        <td><a href="${urlText}" target="_blank" title="${urlText}">${urlText.length > 50 ? urlText.substring(0, 50) + '...' : urlText}</a></td>
                        <td>${fechaText}</td>
                        <td>${redText}</td>
                        <td class="btn-group-actions d-flex">
                            <button class="btn btn-sm btn-info me-1" onclick="abrirModalEditar(${linkId}, 'red_social')">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarLink(${linkId}, 'red_social')">Eliminar</button>
                        </td>
                    `;
                });
            }

            generarPaginacion(count, currentPageRedes, 'pagination-redes', 'cargarLinksRedes');

        } catch (error) {
            console.error("Error cargando links de redes sociales:", error);
            tablaBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los links: ' + error.message + '</td></tr>';
            mostrarToast("Error al cargar links de redes sociales", "danger");
        }
    }

    // Función general para mostrar Toast
    function mostrarToast(message, type = 'primary') {
        const toastEl = document.getElementById('liveToast');
        const toastBody = document.getElementById('toastBody');
        if (toastEl && toastBody) {
            toastBody.textContent = message;
            toastEl.className = `toast align-items-center text-bg-${type} border-0`;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    }

    // Función para obtener CSRF token de cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Función para abrir modal de edición
    async function abrirModalEditar(id, tipo) {
        const modalEl = document.getElementById('modalEditar');
        if (!modalEl) return;
        
        const modal = new bootstrap.Modal(modalEl);
        document.getElementById('editarId').value = id;
        document.getElementById('editarTipo').value = tipo;

        // Ocultar todos los grupos
        const diarioGroup = document.getElementById('editarDiarioGroup');
        const redSocialGroup = document.getElementById('editarRedSocialGroup');
        
        if (diarioGroup) diarioGroup.classList.add('d-none');
        if (redSocialGroup) redSocialGroup.classList.add('d-none');

        let urlApi = '';
        let selectElement = null;

        if (tipo === 'diario') {
            urlApi = `/api/links/${id}/?tipo=diario`;
            if (diarioGroup) diarioGroup.classList.remove('d-none');
            selectElement = document.getElementById('editarDiario');
        } else if (tipo === 'red_social') {
            urlApi = `/api/links/${id}/?tipo=red_social`;
            if (redSocialGroup) redSocialGroup.classList.remove('d-none');
            selectElement = document.getElementById('editarRedSocial');
        }

        try {
            const res = await fetch(urlApi);
            if (!res.ok) throw new Error('Error al obtener datos del link');
            const link = await res.json();

            document.getElementById('editarUrl').value = link.url;
            
            // Seleccionar el valor actual
            if (selectElement) {
                if (tipo === 'diario') {
                    selectElement.value = link.diario_id || '';
                } else if (tipo === 'red_social') {
                    selectElement.value = link.red_social_id || '';
                }
            }

            modal.show();
        } catch (error) {
            console.error("Error al cargar datos para editar:", error);
            mostrarToast("No se pudo cargar el link para edición", "danger");
        }
    }

    // Función para manejar la edición del link
    document.getElementById('formEditar').addEventListener('submit', async function (e) {
        e.preventDefault();
        const id = document.getElementById('editarId').value;
        const tipo = document.getElementById('editarTipo').value;
        const url = document.getElementById('editarUrl').value;
        
        let data = { url: url };
        let urlApi = '';
        let currentPage = 1;
        let successCallback = null;

        if (tipo === 'diario') {
            data.diario_id = document.getElementById('editarDiario').value || null;
            urlApi = `/api/links/${id}/?tipo=diario`;
            currentPage = currentPageLinks;
            successCallback = () => cargarLinks(currentPage);
        } else if (tipo === 'red_social') {
            data.red_social_id = document.getElementById('editarRedSocial').value || null;
            urlApi = `/api/links/${id}/?tipo=red_social`;
            currentPage = currentPageRedes;
            successCallback = () => cargarLinksRedes(currentPage);
        }

        try {
            const res = await fetch(urlApi, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditar'));
                if (modal) modal.hide();
                mostrarToast('Link actualizado correctamente', 'success');
                if (successCallback) successCallback();
            } else {
                const errorData = await res.json().catch(() => ({}));
                const errorMessage = errorData.detail || errorData.error || `Error: ${JSON.stringify(errorData)}`;
                mostrarToast(`Error al actualizar: ${errorMessage}`, 'danger');
            }
        } catch (error) {
            console.error("Error al actualizar el link:", error);
            mostrarToast("Error de conexión al actualizar el link", "danger");
        }
    });

    // Función para manejar la eliminación del link
    async function eliminarLink(id, tipo) {
        const result = await Swal.fire({
            title: '¿Estás seguro?',
            text: `Vas a eliminar este link de ${tipo}. ¡Esta acción es irreversible!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            let urlApi = '';
            let currentPage = 1;
            let successCallback = null;

            if (tipo === 'diario') {
                urlApi = `/api/links/${id}/?tipo=diario`;
                currentPage = currentPageLinks;
                successCallback = () => cargarLinks(currentPage);
            } else if (tipo === 'red_social') {
                urlApi = `/api/links/${id}/?tipo=red_social`;
                currentPage = currentPageRedes;
                successCallback = () => cargarLinksRedes(currentPage);
            }

            try {
                const res = await fetch(urlApi, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });

                if (res.ok) {
                    mostrarToast('Link eliminado correctamente', 'success');
                    if (successCallback) successCallback();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    const errorMessage = errorData.detail || errorData.error || `Error al eliminar el link`;
                    mostrarToast(errorMessage, 'danger');
                }
            } catch (error) {
                console.error("Error al eliminar el link:", error);
                mostrarToast("Error de conexión al eliminar el link", "danger");
            }
        }
    }

    // Manejar envío de formulario de Diario Digital
    document.getElementById('formulario-link').addEventListener('submit', async function (e) {
        e.preventDefault();
        const url = document.getElementById('url').value;

        try {
            const res = await fetch('/api/links/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ url: url, tipo: 'diario' })
            });

            if (res.ok) {
                document.getElementById('url').value = '';
                mostrarToast('Link de diario agregado correctamente', 'success');
                cargarLinks(1);
            } else {
                const errorData = await res.json().catch(() => ({}));
                const errorMessage = errorData.detail || errorData.error || `Error: ${JSON.stringify(errorData)}`;
                mostrarToast(`Error al agregar link: ${errorMessage}`, 'danger');
            }
        } catch (error) {
            console.error("Error al agregar link de diario:", error);
            mostrarToast("Error de conexión al agregar link de diario", "danger");
        }
    });

    // Manejar envío de formulario de Redes Sociales
    document.getElementById('formulario-link-redes').addEventListener('submit', async function (e) {
        e.preventDefault();
        const url = document.getElementById('red_url').value;
        const redSocialId = document.getElementById('red_social_select_form').value || null;

        try {
            const res = await fetch('/api/links/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ url: url, tipo: 'red_social', red_social_id: redSocialId })
            });

            if (res.ok) {
                document.getElementById('red_url').value = '';
                document.getElementById('red_social_select_form').value = '';
                mostrarToast('Link de red social agregado correctamente', 'success');
                cargarLinksRedes(1);
            } else {
                const errorData = await res.json().catch(() => ({}));
                const errorMessage = errorData.detail || errorData.error || `Error: ${JSON.stringify(errorData)}`;
                mostrarToast(`Error al agregar link: ${errorMessage}`, 'danger');
            }
        } catch (error) {
            console.error("Error al agregar link de red social:", error);
            mostrarToast("Error de conexión al agregar link de red social", "danger");
        }
    });

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        cargarDiarios();
        cargarRedes();
        
        // Cargar los links iniciales
        cargarLinks(1);
        
        // Agregar listener para cambiar de pestaña
        const tabs = document.querySelectorAll('#categoriasTabs button');
        tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                const targetId = event.target.getAttribute('data-bs-target');
                console.log("Cambiando a pestaña:", targetId);
                
                if (targetId === '#redes') {
                    // Cargar redes sociales si no se han cargado
                    if (redesDisponibles.length === 0) {
                        cargarRedes();
                    }
                    // Cargar links de redes sociales
                    cargarLinksRedes(1);
                }
                if (targetId === '#diarios') {
                    // Recargar diarios por si se agregaron nuevos links
                    cargarLinks(1); 
                }
            });
        });
    });

</script>
{% endblock %}