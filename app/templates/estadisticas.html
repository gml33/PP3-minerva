{% extends 'base.html' %}
{% block title %}Estadísticas de Prensa{% endblock %}

{% block content %}
<h1 class="mb-3 text-center text-uppercase">Panel de estadísticas para prensa</h1>
<p class="text-muted text-center mb-4">
    Visualiza cuántos links relevantes cargó cada usuario con rol de prensa, cómo fueron evaluados por
    clasificación y desde qué diarios digitales o redes sociales procede la información.
</p>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Desde</label>
                <input type="date" name="desde" class="form-control" value="{{ filtros.desde }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Hasta</label>
                <input type="date" name="hasta" class="form-control" value="{{ filtros.hasta }}">
            </div>
            {% if filtros.usuario %}
            <input type="hidden" name="usuario" value="{{ filtros.usuario }}">
            {% endif %}
            <div class="col-md-4 text-md-end">
                <button type="submit" class="btn btn-primary px-4">Aplicar filtros</button>
                <a href="{% url 'estadisticas' %}" class="btn btn-outline-secondary ms-2">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<div class="row g-3 mb-5">
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-primary text-white">
            <span>Total de links cargados</span>
            <strong>{{ resumen_global.total_links }}</strong>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-success text-white">
            <span>Aprobados por clasificación</span>
            <strong>{{ resumen_global.total_aprobados }}</strong>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-danger text-white">
            <span>Rechazados por clasificación</span>
            <strong>{{ resumen_global.total_rechazados }}</strong>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-dark text-white">
            <span>Links de redes sociales</span>
            <strong>{{ resumen_global.total_redes_sociales }}</strong>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Actividad general de usuarios</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartLinksUsuarios" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartLinksUsuariosEmpty">
                        No hay datos para mostrar en este gráfico.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Resultados de clasificación</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartAprobados" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartAprobadosEmpty">
                        No hay datos para mostrar en este gráfico.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Diarios digitales más utilizados</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartDiarios" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartDiariosEmpty">
                        No hay registros suficientes de diarios digitales.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Redes sociales más utilizadas</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartRedes" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartRedesEmpty">
                        No hay registros suficientes de redes sociales.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if estadisticas %}
    {% for usuario in estadisticas %}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center">
            <div>
                <h5 class="mb-1">{{ usuario.nombre }}</h5>
                <small class="text-muted">Usuario: {{ usuario.username }}</small>
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3 mt-lg-0">
                <div class="badge bg-primary p-2">Totales: {{ usuario.total_links }}</div>
                <div class="badge bg-success p-2">Aprobados: {{ usuario.aprobados }}</div>
                <div class="badge bg-danger p-2">Rechazados: {{ usuario.rechazados }}</div>
                <div class="badge bg-secondary p-2">Redes sociales: {{ usuario.total_redes_sociales }}</div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <h6 class="text-uppercase text-muted">Links por diario digital</h6>
                    {% if usuario.diarios %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Diario</th>
                                    <th class="text-end">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for diario in usuario.diarios %}
                                <tr>
                                    <td>{{ diario.nombre }}</td>
                                    <td class="text-end fw-semibold">{{ diario.cantidad }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-light border">No se registraron diarios para este usuario en el rango seleccionado.</div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h6 class="text-uppercase text-muted">Links por red social</h6>
                    {% if usuario.redes_sociales %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Red social</th>
                                    <th class="text-end">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for red in usuario.redes_sociales %}
                                <tr>
                                    <td>{{ red.nombre }}</td>
                                    <td class="text-end fw-semibold">{{ red.cantidad }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-light border">No se cargaron links de redes sociales para este usuario en el rango seleccionado.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary">
        No se encontraron usuarios de prensa o registros en el rango de fechas indicado. Ajusta los filtros e intenta nuevamente.
    </div>
{% endif %}

<style>
    .stat-card {
        border-radius: .75rem;
        padding: 1.25rem;
        height: 100%;
    }
    .stat-card span {
        display: block;
        font-size: .9rem;
        text-transform: uppercase;
        letter-spacing: .05em;
    }
    .stat-card strong {
        font-size: 2rem;
        line-height: 1;
    }
    .chart-wrapper {
        position: relative;
        min-height: 280px;
    }
</style>

{{ estadisticas|json_script:"stats-data" }}
{{ datos_globales|json_script:"global-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
    const statsData = JSON.parse(document.getElementById("stats-data").textContent || "[]");
    const globalData = JSON.parse(document.getElementById("global-data").textContent || "{}");

    const chartColors = [
        "#2563eb",
        "#16a34a",
        "#f97316",
        "#dc2626",
        "#9333ea",
        "#0ea5e9",
        "#6366f1",
        "#d946ef"
    ];
    const chartTextColor = "#0f172a";

    if (window.Chart) {
        Chart.defaults.color = chartTextColor;
        Chart.defaults.plugins.legend.labels.color = chartTextColor;
        Chart.defaults.plugins.title.color = chartTextColor;
    }

    const showFallback = (elementId) => {
        const el = document.getElementById(elementId);
        if (el) {
            el.classList.remove("d-none");
        }
    };

    const renderBarTotales = () => {
        if (!statsData.length) {
            showFallback("chartLinksUsuariosEmpty");
            return;
        }
        const ctx = document.getElementById("chartLinksUsuarios");
        const labels = statsData.map((item) => item.nombre || item.username);
        const totals = statsData.map((item) => item.total_links);

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Links cargados",
                        data: totals,
                        backgroundColor: "#2563eb"
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true },
                    title: {
                        display: true,
                        text: "Links cargados por usuario",
                        color: chartTextColor
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderBarAprobados = () => {
        if (!statsData.length) {
            showFallback("chartAprobadosEmpty");
            return;
        }
        const ctx = document.getElementById("chartAprobados");
        const labels = statsData.map((item) => item.nombre || item.username);
        const aprobados = statsData.map((item) => item.aprobados);
        const rechazados = statsData.map((item) => item.rechazados);

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Aprobados",
                        backgroundColor: "#16a34a",
                        data: aprobados
                    },
                    {
                        label: "Rechazados",
                        backgroundColor: "#dc2626",
                        data: rechazados
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: { enabled: true },
                    title: {
                        display: true,
                        text: "Resultados de clasificación",
                        color: chartTextColor
                    }
                },
                scales: {
                    y: { stacked: true, beginAtZero: true },
                    x: { stacked: true }
                }
            }
        });
    };

    const renderDonut = (elementId, emptyId, dataset = []) => {
        if (!dataset.length) {
            showFallback(emptyId);
            return;
        }
        const ctx = document.getElementById(elementId);
        const labels = dataset.map((item) => item.nombre);
        const values = dataset.map((item) => item.cantidad);
        const colors = labels.map((_, idx) => chartColors[idx % chartColors.length]);

        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels,
                datasets: [
                    {
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: "bottom" },
                    title: {
                        display: true,
                        text: elementId === "chartDiarios" ? "Participación por diario" : "Participación por red social",
                        color: chartTextColor
                    }
                }
            }
        });
    };

    document.addEventListener("DOMContentLoaded", () => {
        renderBarTotales();
        renderBarAprobados();
        renderDonut("chartDiarios", "chartDiariosEmpty", globalData.diarios || []);
        renderDonut("chartRedes", "chartRedesEmpty", globalData.redes_sociales || []);
    });
</script>
{% endblock %}
