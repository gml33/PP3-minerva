{% extends 'base.html' %}
{% block title %}Estadísticas de Prensa{% endblock %}

{% block content %}
<h1 class="mb-3 text-center text-uppercase">Panel de estadísticas para prensa</h1>
<p class="text-muted text-center mb-4">
    Visualiza cuántos links relevantes cargó cada usuario con rol de prensa, cómo fueron evaluados por
    clasificación y desde qué diarios digitales o redes sociales procede la información.
</p>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Desde</label>
                <input type="date" name="desde" class="form-control" value="{{ filtros.desde }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Hasta</label>
                <input type="date" name="hasta" class="form-control" value="{{ filtros.hasta }}">
            </div>
            {% if filtros.usuario %}
            <input type="hidden" name="usuario" value="{{ filtros.usuario }}">
            {% endif %}
            <div class="col-md-4 text-md-end">
                <button type="submit" class="btn btn-primary px-4">Aplicar filtros</button>
                <a href="{% url 'estadisticas' %}" class="btn btn-outline-secondary ms-2">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<div class="row g-3 mb-5">
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-primary text-white">
            <span>Total de links cargados</span>
            <strong>{{ resumen_global.total_links }}</strong>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-success text-white">
            <span>Aprobados por clasificación</span>
            <strong>{{ resumen_global.total_aprobados }}</strong>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-danger text-white">
            <span>Rechazados por clasificación</span>
            <strong>{{ resumen_global.total_rechazados }}</strong>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="stat-card bg-dark text-white">
            <span>Links de redes sociales</span>
            <strong>{{ resumen_global.total_redes_sociales }}</strong>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Actividad general de usuarios</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartLinksUsuarios" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartLinksUsuariosEmpty">
                        No hay datos para mostrar en este gráfico.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Resultados de clasificación</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartAprobados" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartAprobadosEmpty">
                        No hay datos para mostrar en este gráfico.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Diarios digitales más utilizados</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartDiarios" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartDiariosEmpty">
                        No hay registros suficientes de diarios digitales.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Redes sociales más utilizadas</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartRedes" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartRedesEmpty">
                        No hay registros suficientes de redes sociales.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if estadisticas %}
    {% for usuario in estadisticas %}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center">
            <div>
                <h5 class="mb-1">{{ usuario.nombre }}</h5>
                <small class="text-muted">Usuario: {{ usuario.username }}</small>
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3 mt-lg-0">
                <div class="badge bg-primary p-2">Totales: {{ usuario.total_links }}</div>
                <div class="badge bg-success p-2">Aprobados: {{ usuario.aprobados }}</div>
                <div class="badge bg-danger p-2">Rechazados: {{ usuario.rechazados }}</div>
                <div class="badge bg-secondary p-2">Redes sociales: {{ usuario.total_redes_sociales }}</div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <h6 class="text-uppercase text-muted">Links por diario digital</h6>
                    {% if usuario.diarios %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Diario</th>
                                    <th class="text-end">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for diario in usuario.diarios %}
                                <tr>
                                    <td>{{ diario.nombre }}</td>
                                    <td class="text-end fw-semibold">{{ diario.cantidad }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-light border">No se registraron diarios para este usuario en el rango seleccionado.</div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h6 class="text-uppercase text-muted">Links por red social</h6>
                    {% if usuario.redes_sociales %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Red social</th>
                                    <th class="text-end">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for red in usuario.redes_sociales %}
                                <tr>
                                    <td>{{ red.nombre }}</td>
                                    <td class="text-end fw-semibold">{{ red.cantidad }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-light border">No se cargaron links de redes sociales para este usuario en el rango seleccionado.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary">
        No se encontraron usuarios de prensa o registros en el rango de fechas indicado. Ajusta los filtros e intenta nuevamente.
    </div>
{% endif %}

<hr class="my-5">

<h2 class="mb-3 text-center text-uppercase">Estadísticas del equipo de clasificación</h2>
<p class="text-muted text-center mb-4">
    Monitorea el rendimiento de cada clasificador: volumen de links resueltos, velocidad de respuesta,
    porcentajes de aprobación y las categorías más frecuentes que procesan.
    Actualmente hay <strong>{{ clasificacion.pendientes }}</strong> links pendientes de clasificación.
</p>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            {% if filtros.usuario %}<input type="hidden" name="usuario" value="{{ filtros.usuario }}">{% endif %}
            {% if filtros.desde %}<input type="hidden" name="desde" value="{{ filtros.desde }}">{% endif %}
            {% if filtros.hasta %}<input type="hidden" name="hasta" value="{{ filtros.hasta }}">{% endif %}
            <div class="col-md-4">
                <label class="form-label">Clasificación desde</label>
                <input type="date" name="clas_desde" class="form-control" value="{{ clas_filtros.desde|default:'' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Clasificación hasta</label>
                <input type="date" name="clas_hasta" class="form-control" value="{{ clas_filtros.hasta|default:'' }}">
            </div>
            <div class="col-md-4 text-md-end">
                <button type="submit" class="btn btn-primary px-4">Aplicar filtros de clasificación</button>
                <a href="?{% if filtros.usuario %}usuario={{ filtros.usuario }}&{% endif %}{% if filtros.desde %}desde={{ filtros.desde }}&{% endif %}{% if filtros.hasta %}hasta={{ filtros.hasta }}&{% endif %}" class="btn btn-outline-secondary ms-2">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Links clasificados por usuario</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartClasificacionTotales" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartClasificacionTotalesEmpty">
                        No hay datos para mostrar en este gráfico.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Resultados por usuario</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartClasificacionResultados" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartClasificacionResultadosEmpty">
                        No hay decisiones registradas en este rango de fechas.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Categorías más clasificadas</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartClasificacionCategorias" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartClasificacionCategoriasEmpty">
                        Todavía no hay categorías asociadas a las clasificaciones en este rango.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if clasificacion.usuarios %}
    {% for clasificador in clasificacion.usuarios %}
    <div class="card shadow-sm mb-4">
        <div class="card-header card-header-clasificacion d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center">
            <div>
                <h5 class="mb-1">{{ clasificador.nombre }}</h5>
                <small class="text-muted">Usuario: {{ clasificador.username }}</small>
            </div>
            <div class="d-flex flex-wrap gap-3 mt-3 mt-lg-0">
                <div class="metric-pill metric-total">
                    <span class="metric-label">Links clasificados</span>
                    <span class="metric-value">{{ clasificador.links_clasificados }}</span>
                </div>
                <div class="metric-pill metric-tiempo">
                    <span class="metric-label">Promedio (hs)</span>
                    <span class="metric-value">{{ clasificador.promedio_horas }}</span>
                </div>
                <div class="metric-pill metric-aprobados">
                    <span class="metric-label">Aprobados</span>
                    <span class="metric-value">{{ clasificador.aprobados }}</span>
                </div>
                <div class="metric-pill metric-rechazados">
                    <span class="metric-label">Rechazados</span>
                    <span class="metric-value">{{ clasificador.rechazados }}</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <div class="d-flex justify-content-between text-muted small mb-1">
                    <span>Aprobados {{ clasificador.aprobados_pct }}%</span>
                    <span>Rechazados {{ clasificador.rechazados_pct }}%</span>
                </div>
                <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-success" style="width: {{ clasificador.aprobados_pct }}%"></div>
                    <div class="progress-bar bg-danger" style="width: {{ clasificador.rechazados_pct }}%"></div>
                </div>
            </div>
            <div>
                <h6 class="text-uppercase text-muted">Distribución de categorías</h6>
                {% if clasificador.categorias %}
                <div class="list-group list-group-flush small">
                    {% for categoria in clasificador.categorias|slice:":6" %}
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>{{ categoria.nombre }}</span>
                        <span class="fw-semibold">{{ categoria.porcentaje }}% <small class="text-muted">({{ categoria.cantidad }})</small></span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-light border">Todavía no hay categorías asociadas a sus clasificaciones en este rango.</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary">
        No se registran actividades de clasificación para el rango seleccionado.
    </div>
{% endif %}

<hr class="my-5">

<h2 class="mb-3 text-center text-uppercase">Estadísticas del equipo de redacción</h2>
<p class="text-muted text-center mb-4">
    Analiza cómo trabajan los redactores: artículos generados, tiempos de respuesta luego de la clasificación,
    promedio de links consultados y producción de órdenes de búsqueda y hechos delictivos.
</p>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            {% if filtros.usuario %}<input type="hidden" name="usuario" value="{{ filtros.usuario }}">{% endif %}
            {% if filtros.desde %}<input type="hidden" name="desde" value="{{ filtros.desde }}">{% endif %}
            {% if filtros.hasta %}<input type="hidden" name="hasta" value="{{ filtros.hasta }}">{% endif %}
            {% if clas_filtros.desde %}<input type="hidden" name="clas_desde" value="{{ clas_filtros.desde }}">{% endif %}
            {% if clas_filtros.hasta %}<input type="hidden" name="clas_hasta" value="{{ clas_filtros.hasta }}">{% endif %}
            <div class="col-md-4">
                <label class="form-label">Redacción desde</label>
                <input type="date" name="redac_desde" class="form-control" value="{{ redac_filtros.desde|default:'' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Redacción hasta</label>
                <input type="date" name="redac_hasta" class="form-control" value="{{ redac_filtros.hasta|default:'' }}">
            </div>
            <div class="col-md-4 text-md-end">
                <button type="submit" class="btn btn-primary px-4">Aplicar filtros de redacción</button>
                <a href="?{% if filtros.usuario %}usuario={{ filtros.usuario }}&{% endif %}{% if filtros.desde %}desde={{ filtros.desde }}&{% endif %}{% if filtros.hasta %}hasta={{ filtros.hasta }}&{% endif %}{% if clas_filtros.desde %}clas_desde={{ clas_filtros.desde }}&{% endif %}{% if clas_filtros.hasta %}clas_hasta={{ clas_filtros.hasta }}&{% endif %}" class="btn btn-outline-secondary ms-2">Limpiar</a>
            </div>
        </form>
    </div>
</div>

{% with resumen=redaccion.global.summary %}
<div class="row g-3 mb-4">
    <div class="col-md-4 col-sm-6">
        <div class="stat-card bg-primary text-white">
            <span>Artículos generados</span>
            <strong>{{ resumen.total_articulos|default:0 }}</strong>
        </div>
    </div>
    <div class="col-md-4 col-sm-6">
        <div class="stat-card bg-info text-white">
            <span>Órdenes de búsqueda</span>
            <strong>{{ resumen.total_busquedas|default:0 }}</strong>
        </div>
    </div>
    <div class="col-md-4 col-sm-6">
<<<<<<< HEAD
        <div class="stat-card bg-purple text-white" style="background:#7c3aed;">
=======
        <div class="stat-card bg-purple text-white">
>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693
            <span>Hechos delictivos</span>
            <strong>{{ resumen.total_hechos|default:0 }}</strong>
        </div>
    </div>
</div>
{% endwith %}

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Artículos por redactor</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartRedaccionArticulos" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartRedaccionArticulosEmpty">
                        No hay artículos registrados para este rango.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Promedio de horas tras la clasificación</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartRedaccionTiempos" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartRedaccionTiemposEmpty">
                        No hay datos suficientes para calcular el tiempo promedio.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Promedio de links por artículo</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartRedaccionLinks" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartRedaccionLinksEmpty">
                        No se registran links asociados en este rango.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Órdenes vs Hechos</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartRedaccionResumen" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartRedaccionResumenEmpty">
                        Aún no hay órdenes de búsqueda ni hechos delictivos en este rango.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if redaccion.usuarios %}
    {% for redactor in redaccion.usuarios %}
    <div class="card shadow-sm mb-4">
        <div class="card-header card-header-clasificacion d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center">
            <div>
                <h5 class="mb-1">{{ redactor.nombre }}</h5>
                <small class="text-muted">Usuario: {{ redactor.username }}</small>
            </div>
            <div class="d-flex flex-wrap gap-3 mt-3 mt-lg-0">
                <div class="metric-pill metric-total">
                    <span class="metric-label">Artículos</span>
                    <span class="metric-value">{{ redactor.articulos }}</span>
                </div>
                <div class="metric-pill metric-tiempo">
                    <span class="metric-label">Promedio (hs)</span>
                    <span class="metric-value">{{ redactor.promedio_tiempo_horas }}</span>
                </div>
                <div class="metric-pill metric-links">
                    <span class="metric-label">Links por artículo</span>
                    <span class="metric-value">{{ redactor.promedio_links }}</span>
                </div>
                <div class="metric-pill metric-busquedas">
                    <span class="metric-label">Órdenes</span>
                    <span class="metric-value">{{ redactor.ordenes_busqueda }}</span>
                </div>
                <div class="metric-pill metric-hechos">
                    <span class="metric-label">Hechos</span>
                    <span class="metric-value">{{ redactor.hechos_delictivos }}</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-2">
                Cada barra refleja el promedio de tiempo en el que {{ redactor.nombre }} transforma links clasificados en artículos,
                junto con el nivel de investigación adicional requerido.
            </p>
            <ul class="list-group list-group-flush small">
                <li class="list-group-item px-0 d-flex justify-content-between">
                    <span>Total de artículos en el rango</span>
                    <strong>{{ redactor.articulos }}</strong>
                </li>
                <li class="list-group-item px-0 d-flex justify-content-between">
                    <span>Órdenes de búsqueda generadas</span>
                    <strong>{{ redactor.ordenes_busqueda }}</strong>
                </li>
                <li class="list-group-item px-0 d-flex justify-content-between">
                    <span>Hechos delictivos documentados</span>
                    <strong>{{ redactor.hechos_delictivos }}</strong>
                </li>
            </ul>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary">
        No se encontraron registros de redacción para el rango seleccionado.
    </div>
{% endif %}

<<<<<<< HEAD
=======
<hr class="my-5">

<h2 class="mb-3 text-center text-uppercase">Estadísticas del equipo de informes</h2>
<p class="text-muted text-center mb-4">
    Controla la generación de informes: volumen por analista, cuántos artículos consulta cada uno y en qué categorías
    se están especializando.
</p>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            {% if filtros.usuario %}<input type="hidden" name="usuario" value="{{ filtros.usuario }}">{% endif %}
            {% if filtros.desde %}<input type="hidden" name="desde" value="{{ filtros.desde }}">{% endif %}
            {% if filtros.hasta %}<input type="hidden" name="hasta" value="{{ filtros.hasta }}">{% endif %}
            {% if clas_filtros.desde %}<input type="hidden" name="clas_desde" value="{{ clas_filtros.desde }}">{% endif %}
            {% if clas_filtros.hasta %}<input type="hidden" name="clas_hasta" value="{{ clas_filtros.hasta }}">{% endif %}
            {% if redac_filtros.desde %}<input type="hidden" name="redac_desde" value="{{ redac_filtros.desde }}">{% endif %}
            {% if redac_filtros.hasta %}<input type="hidden" name="redac_hasta" value="{{ redac_filtros.hasta }}">{% endif %}
            <div class="col-md-4">
                <label class="form-label">Informes desde</label>
                <input type="date" name="info_desde" class="form-control" value="{{ info_filtros.desde|default:'' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Informes hasta</label>
                <input type="date" name="info_hasta" class="form-control" value="{{ info_filtros.hasta|default:'' }}">
            </div>
            <div class="col-md-4 text-md-end">
                <button type="submit" class="btn btn-primary px-4">Aplicar filtros de informes</button>
                <a href="?{% if filtros.usuario %}usuario={{ filtros.usuario }}&{% endif %}{% if filtros.desde %}desde={{ filtros.desde }}&{% endif %}{% if filtros.hasta %}hasta={{ filtros.hasta }}&{% endif %}{% if clas_filtros.desde %}clas_desde={{ clas_filtros.desde }}&{% endif %}{% if clas_filtros.hasta %}clas_hasta={{ clas_filtros.hasta }}&{% endif %}{% if redac_filtros.desde %}redac_desde={{ redac_filtros.desde }}&{% endif %}{% if redac_filtros.hasta %}redac_hasta={{ redac_filtros.hasta }}&{% endif %}" class="btn btn-outline-secondary ms-2">Limpiar</a>
            </div>
        </form>
    </div>
</div>

{% with resumen=informes.global.summary %}
<div class="row g-3 mb-4">
    <div class="col-md-4 col-sm-6">
        <div class="stat-card bg-primary text-white">
            <span>Total de informes</span>
            <strong>{{ resumen.total_informes|default:0 }}</strong>
        </div>
    </div>
    <div class="col-md-4 col-sm-6">
        <div class="stat-card bg-success text-white">
            <span>Promedio artículos por informe</span>
            <strong>{{ resumen.promedio_articulos|default:0 }}</strong>
        </div>
    </div>
    <div class="col-md-4 col-sm-6">
        <div class="stat-card bg-dark text-white">
            <span>Promedio por categoría</span>
            <strong>{{ resumen.promedio_categoria|default:0 }}</strong>
        </div>
    </div>
</div>
{% endwith %}

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Informes por analista</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartInformesUsuarios" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartInformesUsuariosEmpty">
                        Aún no se registran informes para este rango.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Promedio de artículos por informe</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartInformesPromedio" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartInformesPromedioEmpty">
                        No hay datos suficientes para calcular el promedio.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-body-secondary">Informes por categoría</div>
            <div class="card-body">
                <div class="chart-wrapper">
                    <canvas id="chartInformesCategorias" height="320"></canvas>
                    <p class="text-muted text-center small d-none" id="chartInformesCategoriasEmpty">
                        No se identificaron categorías para los informes de este rango.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if informes.usuarios %}
    {% for analista in informes.usuarios %}
    <div class="card shadow-sm mb-4">
        <div class="card-header card-header-clasificacion d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center">
            <div>
                <h5 class="mb-1">{{ analista.nombre }}</h5>
                <small class="text-muted">Usuario: {{ analista.username }}</small>
            </div>
            <div class="d-flex flex-wrap gap-3 mt-3 mt-lg-0">
                <div class="metric-pill metric-total">
                    <span class="metric-label">Informes</span>
                    <span class="metric-value">{{ analista.informes }}</span>
                </div>
                <div class="metric-pill metric-links">
                    <span class="metric-label">Artículos por informe</span>
                    <span class="metric-value">{{ analista.promedio_articulos }}</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <h6 class="text-uppercase text-muted">Categorías destacadas</h6>
            {% if analista.categorias %}
            <div class="list-group list-group-flush small">
                {% for categoria in analista.categorias|slice:":6" %}
                <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                    <span>{{ categoria.nombre }}</span>
                    <span class="fw-semibold">{{ categoria.cantidad }} informe(s)</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-light border">No se registran categorías para los informes de este analista en el rango filtrado.</div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-secondary">
        No se registran informes para el rango seleccionado.
    </div>
{% endif %}

>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693
<style>
    .stat-card {
        border-radius: .75rem;
        padding: 1.25rem;
        height: 100%;
    }
    .stat-card span {
        display: block;
        font-size: .9rem;
        text-transform: uppercase;
        letter-spacing: .05em;
    }
    .stat-card strong {
        font-size: 2rem;
        line-height: 1;
    }
    .chart-wrapper {
        position: relative;
        min-height: 280px;
    }
    .progress {
        background-color: #e5e7eb;
        height: 0.85rem;
    }
    .metric-pill {
        border-radius: 0.85rem;
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        min-width: 150px;
        color: #fff;
    }
    .metric-label {
        text-transform: uppercase;
        font-size: 0.72rem;
        letter-spacing: 0.05em;
        opacity: 0.9;
    }
    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.1;
    }
    .metric-total { background: #0f172a; }
    .metric-tiempo { background: #1d4ed8; }
    .metric-aprobados { background: #047857; }
    .metric-rechazados { background: #b91c1c; }
    .metric-links { background: #0284c7; }
    .metric-busquedas { background: #0d9488; }
    .metric-hechos { background: #7c3aed; }
    .metric-pill .metric-value { color: #fff; }
    .card-header-clasificacion {
        background: #f8fafc;
        color: #0f172a;
        border-bottom: 1px solid #e2e8f0;
    }
<<<<<<< HEAD
=======
    .bg-purple { background: #7c3aed !important; }
>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693
</style>

{{ estadisticas|json_script:"stats-data" }}
{{ datos_globales|json_script:"global-data" }}
{{ clasificacion|json_script:"clasificacion-data" }}
{{ redaccion|json_script:"redaccion-data" }}
<<<<<<< HEAD
=======
{{ informes|json_script:"informes-data" }}
>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
    const statsData = JSON.parse(document.getElementById("stats-data").textContent || "[]");
    const globalData = JSON.parse(document.getElementById("global-data").textContent || "{}");
    const clasificacionData = JSON.parse(document.getElementById("clasificacion-data").textContent || "{}");
    const redaccionData = JSON.parse(document.getElementById("redaccion-data").textContent || "{}");
<<<<<<< HEAD
=======
    const informesData = JSON.parse(document.getElementById("informes-data").textContent || "{}");
>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693

    const chartColors = [
        "#2563eb",
        "#16a34a",
        "#f97316",
        "#dc2626",
        "#9333ea",
        "#0ea5e9",
        "#6366f1",
        "#d946ef"
    ];
    const chartTextColor = "#0f172a";

    if (window.Chart) {
        Chart.defaults.color = chartTextColor;
        Chart.defaults.plugins.legend.labels.color = chartTextColor;
        Chart.defaults.plugins.title.color = chartTextColor;
    }

    const showFallback = (elementId) => {
        const el = document.getElementById(elementId);
        if (el) {
            el.classList.remove("d-none");
        }
    };

    const renderBarTotales = () => {
        if (!statsData.length) {
            showFallback("chartLinksUsuariosEmpty");
            return;
        }
        const ctx = document.getElementById("chartLinksUsuarios");
        const labels = statsData.map((item) => item.nombre || item.username);
        const totals = statsData.map((item) => item.total_links);

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Links cargados",
                        data: totals,
                        backgroundColor: "#2563eb"
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true },
                    title: {
                        display: true,
                        text: "Links cargados por usuario",
                        color: chartTextColor
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderBarAprobados = () => {
        if (!statsData.length) {
            showFallback("chartAprobadosEmpty");
            return;
        }
        const ctx = document.getElementById("chartAprobados");
        const labels = statsData.map((item) => item.nombre || item.username);
        const aprobados = statsData.map((item) => item.aprobados);
        const rechazados = statsData.map((item) => item.rechazados);

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Aprobados",
                        backgroundColor: "#16a34a",
                        data: aprobados
                    },
                    {
                        label: "Rechazados",
                        backgroundColor: "#dc2626",
                        data: rechazados
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: { enabled: true },
                    title: {
                        display: true,
                        text: "Resultados de clasificación",
                        color: chartTextColor
                    }
                },
                scales: {
                    y: { stacked: true, beginAtZero: true },
                    x: { stacked: true }
                }
            }
        });
    };

    const renderDonut = (elementId, emptyId, dataset = []) => {
        if (!dataset.length) {
            showFallback(emptyId);
            return;
        }
        const ctx = document.getElementById(elementId);
        const labels = dataset.map((item) => item.nombre);
        const values = dataset.map((item) => item.cantidad);
        const colors = labels.map((_, idx) => chartColors[idx % chartColors.length]);

        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels,
                datasets: [
                    {
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: "bottom" },
                    title: {
                        display: true,
                        text: elementId === "chartDiarios" ? "Participación por diario" : "Participación por red social",
                        color: chartTextColor
                    }
                }
            }
        });
    };

    const renderClasificacionTotales = () => {
        const usuarios = clasificacionData.usuarios || [];
        if (!usuarios.length) {
            showFallback("chartClasificacionTotalesEmpty");
            return;
        }
        const ctx = document.getElementById("chartClasificacionTotales");
        const labels = usuarios.map((u) => u.nombre || u.username);
        const valores = usuarios.map((u) => u.links_clasificados || 0);
        const tieneDatos = valores.some((value) => value > 0);
        if (!tieneDatos) {
            showFallback("chartClasificacionTotalesEmpty");
            return;
        }

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Links clasificados",
                        data: valores,
                        backgroundColor: "#0f172a"
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true },
                    title: { display: true, text: "Clasificaciones realizadas", color: chartTextColor }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderClasificacionResultados = () => {
        const usuarios = clasificacionData.usuarios || [];
        if (!usuarios.length) {
            showFallback("chartClasificacionResultadosEmpty");
            return;
        }
        const labels = usuarios.map((u) => u.nombre || u.username);
        const aprobados = usuarios.map((u) => u.aprobados || 0);
        const rechazados = usuarios.map((u) => u.rechazados || 0);
        const tieneDatos = usuarios.some((u) => (u.aprobados || 0) + (u.rechazados || 0) > 0);
        if (!tieneDatos) {
            showFallback("chartClasificacionResultadosEmpty");
            return;
        }
        const ctx = document.getElementById("chartClasificacionResultados");

        new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "Aprobados",
                        data: aprobados,
                        backgroundColor: "#0f9d58"
                    },
                    {
                        label: "Rechazados",
                        data: rechazados,
                        backgroundColor: "#d93025"
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: { enabled: true },
                    title: { display: true, text: "Resultados por clasificador", color: chartTextColor }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderClasificacionCategorias = () => {
        const categorias = (clasificacionData.global && clasificacionData.global.categorias) || [];
        if (!categorias.length) {
            showFallback("chartClasificacionCategoriasEmpty");
            return;
        }
        renderDonut("chartClasificacionCategorias", "chartClasificacionCategoriasEmpty", categorias);
    };

    const renderRedaccionBar = (dataset, canvasId, emptyId, title) => {
        if (!dataset || !dataset.length) {
            showFallback(emptyId);
            return;
        }
        const labels = dataset.map((item) => item.nombre);
        const values = dataset.map((item) => item.cantidad || 0);
        const tieneDatos = values.some((value) => value > 0);
        if (!tieneDatos) {
            showFallback(emptyId);
            return;
        }
        new Chart(document.getElementById(canvasId), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: title,
                        data: values,
                        backgroundColor: "#0f172a"
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: title, color: chartTextColor }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    };

    const renderRedaccionResumen = () => {
        const summary = (redaccionData.global && redaccionData.global.summary) || {};
        const busquedas = summary.total_busquedas || 0;
        const hechos = summary.total_hechos || 0;
        if (!busquedas && !hechos) {
            showFallback("chartRedaccionResumenEmpty");
            return;
        }
        renderDonut(
            "chartRedaccionResumen",
            "chartRedaccionResumenEmpty",
            [
                { nombre: "Órdenes", cantidad: busquedas },
                { nombre: "Hechos", cantidad: hechos }
            ]
        );
    };

<<<<<<< HEAD
=======
    const renderInformesBar = (dataset, canvasId, emptyId, title) => {
        if (!dataset || !dataset.length) {
            showFallback(emptyId);
            return;
        }
        const labels = dataset.map((item) => item.nombre);
        const values = dataset.map((item) => item.cantidad || 0);
        if (!values.some((value) => value > 0)) {
            showFallback(emptyId);
            return;
        }
        new Chart(document.getElementById(canvasId), {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: title,
                        backgroundColor: "#0f172a",
                        data: values,
                    },
                ],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: title, color: chartTextColor },
                },
                scales: {
                    y: { beginAtZero: true },
                },
            },
        });
    };

    const renderInformesCategorias = () => {
        const categorias = (informesData.global && informesData.global.categorias) || [];
        if (!categorias.length) {
            showFallback("chartInformesCategoriasEmpty");
            return;
        }
        renderDonut("chartInformesCategorias", "chartInformesCategoriasEmpty", categorias);
    };

>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693
    document.addEventListener("DOMContentLoaded", () => {
        renderBarTotales();
        renderBarAprobados();
        renderDonut("chartDiarios", "chartDiariosEmpty", globalData.diarios || []);
        renderDonut("chartRedes", "chartRedesEmpty", globalData.redes_sociales || []);
        renderClasificacionTotales();
        renderClasificacionResultados();
        renderClasificacionCategorias();
        renderRedaccionBar(
            redaccionData.global ? redaccionData.global.articulos : [],
            "chartRedaccionArticulos",
            "chartRedaccionArticulosEmpty",
            "Artículos generados"
        );
        renderRedaccionBar(
            redaccionData.global ? redaccionData.global.tiempos : [],
            "chartRedaccionTiempos",
            "chartRedaccionTiemposEmpty",
            "Horas promedio"
        );
        renderRedaccionBar(
            redaccionData.global ? redaccionData.global.links : [],
            "chartRedaccionLinks",
            "chartRedaccionLinksEmpty",
            "Links por artículo"
        );
        renderRedaccionResumen();
<<<<<<< HEAD
=======
        renderInformesBar(
            informesData.global ? informesData.global.informes : [],
            "chartInformesUsuarios",
            "chartInformesUsuariosEmpty",
            "Informes por analista"
        );
        renderInformesBar(
            informesData.global ? informesData.global.promedios_articulos : [],
            "chartInformesPromedio",
            "chartInformesPromedioEmpty",
            "Promedio de artículos"
        );
        renderInformesCategorias();
>>>>>>> 2b2d3944a467283ec855f2e3823725e4701e7693
    });
</script>
{% endblock %}
