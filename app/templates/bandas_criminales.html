{% extends 'base.html' %}
{% block title %}Bandas Criminales{% endblock %}

{% block content %}
<h1 class="mb-4">Bandas Criminales</h1>

{% include "partials/messages.html" %}

<div class="card mb-4">
    <div class="card-header">
        {% if modo_edicion %}Editar banda criminal{% else %}Nueva banda criminal{% endif %}
    </div>
    <div class="card-body">
        {% if modo_edicion and banda_actual %}
        <div class="alert alert-info py-2">
            Estás editando <strong>{{ banda_actual.nombre_principal|default:"Banda sin nombre" }}</strong>.
            {% with alias_lista=banda_actual.alias %}
                {% if alias_lista %}
                    <br><small class="text-muted">Alias: {{ alias_lista|join:", " }}</small>
                {% endif %}
            {% endwith %}
        </div>
        {% endif %}
        <form method="post" action="{{ form_action|default:request.path }}">
            {% csrf_token %}
            {% for field in form %}
                {% if field.name == "links_diarios" or field.name == "links_redes" %}
                {{ field }}
                {% elif field.name == "alias" %}
                <div class="mb-3">
                    <label class="form-label" for="id_alias_control">Alias</label>
                    {{ field }}
                    <div id="alias-dynamic-list" class="d-flex flex-column gap-2"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btn-agregar-alias">
                        Agregar alias
                    </button>
                    <div class="form-text">Añadí alias o denominaciones alternativas (opcional).</div>
                    {% if field.errors %}
                    <div class="text-danger small mt-2">
                        {% for error in field.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% elif field.name == "zonas_influencia" %}
                <div class="mb-3">
                    <label class="form-label" for="id_zonas_control">Zonas de influencia</label>
                    {{ field }}
                    <div id="zonas-dynamic-list" class="d-flex flex-column gap-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btn-agregar-zona">
                        Agregar zona
                    </button>
                    <div class="form-text">Indicá barrio, localidad, ciudad y provincia según corresponda.</div>
                    {% if field.errors %}
                    <div class="text-danger small mt-2">
                        {% for error in field.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% elif field.name == "bandas_aliadas" %}
                <div class="mb-3">
                    {{ field.label_tag }}
                    <input type="text" class="form-control form-control-sm mb-2" placeholder="Filtrar por nombre"
                        oninput="filtrarBandasSelect('id_bandas_aliadas', this.value)">
                    {{ field }}
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% if field.errors %}
                    <div class="text-danger small">
                        {% for error in field.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% elif field.name == "bandas_rivales" %}
                <div class="mb-3">
                    {{ field.label_tag }}
                    <input type="text" class="form-control form-control-sm mb-2" placeholder="Filtrar por nombre"
                        oninput="filtrarBandasSelect('id_bandas_rivales', this.value)">
                    {{ field }}
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% if field.errors %}
                    <div class="text-danger small">
                        {% for error in field.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="mb-3">
                    {{ field.label_tag }}
                    {{ field }}
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% if field.errors %}
                    <div class="text-danger small">
                        {% for error in field.errors %}{{ error }}{% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                    {% if modo_edicion %}Guardar cambios{% else %}Crear banda{% endif %}
                </button>
                {% if modo_edicion %}
                <a href="{% url 'bandas_criminales' %}" class="btn btn-secondary">Cancelar</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

{% if rol_usuario == 'redaccion' %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Artículos registrados con categoría "Bandas criminales"</span>
        <span class="badge text-bg-info text-uppercase">Categoría fija: Bandas criminales</span>
    </div>
    <div class="card-body p-0">
        {% if articulos_bandas %}
        <div class="table-responsive">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Barrio</th>
                        <th>Zona de influencia</th>
                        <th>Localidad</th>
                        <th>Provincia</th>
                        <th>Estado</th>
                        <th>Autor</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    {% for articulo in articulos_bandas %}
                    <tr>
                        <td>{{ articulo.id }}</td>
                        <td>{{ articulo.titulo|default:"Sin título" }}</td>
                        <td>{{ articulo.barrio|default:"-" }}</td>
                        <td>{{ articulo.zona_influencia|default:"-" }}</td>
                        <td>{{ articulo.localidad|default:"-" }}</td>
                        <td>{{ articulo.provincia|default:"-" }}</td>
                        <td>{{ articulo.get_estado_display }}</td>
                        <td>
                            {% if articulo.generado_por %}
                                {{ articulo.generado_por.username }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ articulo.fecha_creacion|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted p-3 mb-0">Aún no hay artículos registrados en esta categoría.</p>
        {% endif %}
    </div>
</div>
{% else %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Links aprobados vinculados a bandas criminales</span>
        <span class="badge text-bg-info text-uppercase">Categoría fija: Bandas criminales</span>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end mb-3">
            <div class="col-md-3">
                <label class="form-label" for="bandas_fecha_desde">Desde</label>
                <input type="date" class="form-control" id="bandas_fecha_desde">
            </div>
            <div class="col-md-3">
                <label class="form-label" for="bandas_fecha_hasta">Hasta</label>
                <input type="date" class="form-control" id="bandas_fecha_hasta">
            </div>
            <div class="col-md-3 col-lg-2">
                <label class="form-label" for="bandas_origen">Origen de datos</label>
                <select id="bandas_origen" class="form-select">
                    <option value="diario">Diarios digitales</option>
                    <option value="red_social">Redes sociales</option>
                </select>
            </div>
            <div class="col-md-3 col-lg-2" id="bandas-grupo-diario">
                <label class="form-label" for="bandas_filtro_diario">Diario digital</label>
                <select id="bandas_filtro_diario" class="form-select">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="col-md-3 col-lg-2 d-none" id="bandas-grupo-red">
                <label class="form-label" for="bandas_filtro_red">Red social</label>
                <select id="bandas_filtro_red" class="form-select">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-3 col-lg-2 d-flex">
                <button type="button" class="btn btn-outline-primary w-100" onclick="cargarLinksBandas()">Filtrar</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped mb-0" id="tabla-links-bandas">
                <thead>
                    <tr>
                        <th>Logo</th>
                        <th>Fuente</th>
                        <th>Link</th>
                        <th>Fecha</th>
                        <th>Categorías</th>
                        <th>Asociados</th>
                        <th>Revisado</th>
                        <th>Seleccionar</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center text-muted">Cargando links aprobados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <nav id="paginacion-links-bandas" class="mt-3 d-none">
            <ul class="pagination justify-content-center mb-0"></ul>
        </nav>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">Filtrar bandas criminales</div>
    <div class="card-body">
        <form method="get" action="" class="row g-3">
            <div class="col-md-6">
                <label class="form-label" for="filtro-nombre">Nombre o alias</label>
                <input type="text" class="form-control" id="filtro-nombre" name="nombre" value="{{ filtros.nombre }}" placeholder="Ej: Sapucai">
            </div>
            <div class="col-md-6">
                <label class="form-label" for="filtro-zona">Zona de influencia</label>
                <input type="text" class="form-control" id="filtro-zona" name="zona" value="{{ filtros.zona }}" placeholder="Barrio, ciudad o provincia">
            </div>
            <div class="col-md-6">
                <label class="form-label" for="filtro-aliada">Banda aliada</label>
                <input type="text" class="form-control" id="filtro-aliada" name="aliada" value="{{ filtros.aliada }}" placeholder="Nombre de banda aliada">
            </div>
            <div class="col-md-6">
                <label class="form-label" for="filtro-rival">Banda rival</label>
                <input type="text" class="form-control" id="filtro-rival" name="rival" value="{{ filtros.rival }}" placeholder="Nombre de banda rival">
            </div>
            <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Aplicar filtros</button>
                <a href="{% url 'bandas_criminales' %}" class="btn btn-outline-secondary">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Bandas criminales registradas</div>
    <div class="card-body p-0">
        {% if bandas and bandas.object_list %}
        <div class="table-responsive">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Alias</th>
                        <th>Zonas de influencia</th>
                        <th>Líderes</th>
                        <th>Miembros</th>
                        <th>Bandas aliadas</th>
                        <th>Bandas rivales</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for banda in bandas %}
                    <tr {% if banda_actual and banda.pk == banda_actual.pk %}class="table-info"{% endif %}>
                        <td>
                            {% if banda.nombre_principal %}
                                {{ banda.nombre_principal|truncatechars:35 }}
                            {% else %}
                                <span class="text-muted">Sin nombre</span>
                            {% endif %}
                        </td>
                        <td>
                            {% with alias_lista=banda.alias %}
                                {% if alias_lista %}
                                    {{ alias_lista|join:", "|truncatechars:35 }}
                                {% else %}
                                    <span class="text-muted">Sin alias</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with resumen=banda.zonas_resumen %}
                                {% if resumen %}
                                    {{ resumen|truncatechars:35 }}
                                {% else %}
                                    <span class="text-muted">Sin zonas registradas</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with lideres=banda.lideres.all|join:", " %}
                                {% if lideres %}
                                    {{ lideres|truncatechars:35 }}
                                {% else %}
                                    <span class="text-muted">Sin líderes</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with miembros=banda.miembros.all|join:", " %}
                                {% if miembros %}
                                    {{ miembros|truncatechars:35 }}
                                {% else %}
                                    <span class="text-muted">Sin miembros</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with aliadas=banda.bandas_aliadas.all|join:", " %}
                                {% if aliadas %}
                                    {{ aliadas|truncatechars:35 }}
                                {% else %}
                                    <span class="text-muted">Sin aliadas</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with rivales=banda.bandas_rivales.all|join:", " %}
                                {% if rivales %}
                                    {{ rivales|truncatechars:35 }}
                                {% else %}
                                    <span class="text-muted">Sin rivales</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm mb-2">
                                <button type="button" class="btn btn-outline-info btn-ver-banda"
                                    data-banda-id="{{ banda.pk }}"
                                    data-banda-nombre="{{ banda.nombre_principal|default:banda.nombres_como_texto|default:'Banda criminal' }}"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalDetalleBanda">
                                    Ver
                                </button>
                                <a href="{% url 'banda_criminal_editar' banda.pk %}" class="btn btn-outline-primary">Editar</a>
                            </div>
                            <form method="post" action="{% url 'banda_criminal_eliminar' banda.pk %}" class="d-inline form-eliminar-banda">
                                {% csrf_token %}
                                <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-banda">Eliminar</button>
                            </form>
                            <div id="banda-detalle-{{ banda.pk }}" class="d-none">
                                <p><strong>Nombre:</strong> {{ banda.nombre_principal|default:"Sin nombre" }}</p>
                                <p><strong>Alias:</strong>
                                    {% with alias_lista=banda.alias %}
                                        {% if alias_lista %}
                                            {{ alias_lista|join:", " }}
                                        {% else %}
                                            <span class="text-muted">Sin alias</span>
                                        {% endif %}
                                    {% endwith %}
                                </p>
                                <div class="mb-2">
                                    <strong>Zonas de influencia:</strong>
                                    {% if banda.zonas_influencia_detalle %}
                                        <ul class="mb-0 ps-3">
                                            {% for zona in banda.zonas_influencia_detalle %}
                                                <li>
                                                    {% if zona.barrio %}<strong>Barrio:</strong> {{ zona.barrio }}{% endif %}
                                                    {% if zona.localidad %}{% if zona.barrio %} · {% endif %}<strong>Localidad:</strong> {{ zona.localidad }}{% endif %}
                                                    {% if zona.ciudad %}{% if zona.barrio or zona.localidad %} · {% endif %}<strong>Ciudad:</strong> {{ zona.ciudad }}{% endif %}
                                                    {% if zona.provincia %}{% if zona.barrio or zona.localidad or zona.ciudad %} · {% endif %}<strong>Provincia:</strong> {{ zona.provincia }}{% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="mb-0 text-muted">Sin zonas registradas.</p>
                                    {% endif %}
                                </div>
                                <p><strong>Bandas aliadas:</strong>
                                    {% with aliadas=banda.bandas_aliadas.all %}
                                        {% if aliadas %}
                                            {% for aliada in aliadas %}
                                                {{ aliada.nombre_principal|default:aliada }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">Sin aliadas</span>
                                        {% endif %}
                                    {% endwith %}
                                </p>
                                <p><strong>Bandas rivales:</strong>
                                    {% with rivales=banda.bandas_rivales.all %}
                                        {% if rivales %}
                                            {% for rival in rivales %}
                                                {{ rival.nombre_principal|default:rival }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">Sin rivales</span>
                                        {% endif %}
                                    {% endwith %}
                                </p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="m-3 text-muted">No se encontraron bandas registradas.</p>
        {% endif %}
    </div>
    {% if bandas and bandas.has_other_pages %}
    <div class="card-footer">
        <nav aria-label="Paginación de bandas">
            <ul class="pagination justify-content-center mb-0">
                {% if bandas.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ bandas.previous_page_number }}">Anterior</a>
                </li>
                {% endif %}
                {% for num in bandas.paginator.page_range %}
                    {% if bandas.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}
                {% if bandas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ bandas.next_page_number }}">Siguiente</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
<div class="modal fade" id="modalDetalleBanda" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalleBandaTitulo">Detalle de banda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="modalDetalleBandaBody">
                <p class="text-muted mb-0">Seleccioná una banda para ver los detalles.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleInformeBandas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Detalle del informe</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="detalleInformeBandas">
                <p class="text-muted mb-0">Seleccioná un integrante para ver su informe.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
const CATEGORIA_BANDAS = "bandas criminales";
let categoriaBandasId = null;
let linksBandasGlobal = [];
let paginaLinksBandasActual = 1;
const LINKS_BANDAS_POR_PAGINA = 10;
let diariosBandas = [];
let redesBandas = [];
let linksBandasSeleccionadosDiario = [];
let linksBandasSeleccionadosRed = [];
const linksRevisadosBandas = new Set();
let modalDetalleInformeBandasInstance = null;

document.addEventListener("DOMContentLoaded", async function () {
    inicializarCamposAlias();
    inicializarZonasInfluencia();
    await cargarCategoriaBandas();
    await Promise.all([cargarDiariosBandas(), cargarRedesBandas()]);
    inicializarSeleccionLinksBandas();
    actualizarCamposFuenteBandas();
    await cargarLinksBandas();

    const origenSelect = document.getElementById("bandas_origen");
    if (origenSelect) {
        origenSelect.addEventListener("change", () => {
            actualizarCamposFuenteBandas();
            cargarLinksBandas();
        });
    }

    const modalTitle = document.getElementById("modalDetalleBandaTitulo");
    const modalBody = document.getElementById("modalDetalleBandaBody");
    document.querySelectorAll(".btn-ver-banda").forEach(function (btn) {
        btn.addEventListener("click", function () {
            if (!modalTitle || !modalBody) {
                return;
            }
            const bandaId = btn.dataset.bandaId;
            modalTitle.textContent = btn.dataset.bandaNombre || "Banda criminal";
            const detalle = document.getElementById(`banda-detalle-${bandaId}`);
            modalBody.innerHTML = detalle ? detalle.innerHTML : "<p class='text-muted mb-0'>Sin información disponible.</p>";
        });
    });

    document.querySelectorAll(".form-eliminar-banda").forEach(function (form) {
        const btn = form.querySelector(".btn-eliminar-banda");
        if (!btn) {
            return;
        }
        btn.addEventListener("click", function (event) {
            event.preventDefault();
            Swal.fire({
                title: "¿Eliminar banda criminal?",
                text: "Esta acción no se puede deshacer.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#6c757d",
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar",
            }).then(function (result) {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
});

document.addEventListener("click", function (event) {
    const enlace = event.target.closest(".link-detalle-informe");
    if (!enlace) {
        return;
    }
    event.preventDefault();
    const informeId = enlace.dataset.informeId;
    if (!informeId) {
        return;
    }
    const bandaModalEl = document.getElementById("modalDetalleBanda");
    if (bandaModalEl && window.bootstrap) {
        const bandaModal = window.bootstrap.Modal.getInstance(bandaModalEl);
        if (bandaModal) {
            bandaModal.hide();
        }
    }
    mostrarDetalleInformeDesdeBandas(informeId);
});

function mostrarDetalleInformeDesdeBandas(informeId) {
    const modalElement = document.getElementById("modalDetalleInformeBandas");
    const detalleContainer = document.getElementById("detalleInformeBandas");
    if (!modalElement || !detalleContainer) {
        return;
    }
    if (!modalDetalleInformeBandasInstance && window.bootstrap) {
        modalDetalleInformeBandasInstance = new window.bootstrap.Modal(modalElement);
    }
    if (modalDetalleInformeBandasInstance) {
        modalDetalleInformeBandasInstance.show();
    }
    detalleContainer.innerHTML = "<p class='text-muted mb-0'>Cargando datos del informe...</p>";

    fetch(`/api/informes/${informeId}/detalle/`)
        .then((response) => {
            if (!response.ok) {
                throw new Error("No se pudo cargar el informe");
            }
            return response.json();
        })
        .then((data) => {
            if (data.status !== "ok") {
                throw new Error("Respuesta inválida");
            }
            detalleContainer.innerHTML = construirDetalleInformeHTML(data.informe);
        })
        .catch((error) => {
            console.error("Error al cargar el informe:", error);
            detalleContainer.innerHTML = "<p class='text-danger mb-0'>No se pudo cargar el informe.</p>";
        });
}

function construirDetalleInformeHTML(inf) {
    if (!inf) {
        return "<p class='text-danger mb-0'>No se pudo cargar el informe.</p>";
    }
    const sexo = inf.sexo_display || capitalizarTexto(inf.sexo) || "No informado";
    const aliasTexto = listaEnTexto(inf.alias, "Sin alias registrados");
    const telefonosTexto = listaEnTexto(inf.telefonos, "Sin teléfonos registrados");
    const domicilios = listaComoItems(
        inf.domicilios,
        (d) =>
            `<li>${valorODash(d.calle)} ${valorODash(d.altura)}, ${valorODash(d.barrio)}, ${valorODash(d.ciudad)}, ${valorODash(d.provincia)}</li>`,
        "Sin domicilios registrados"
    );
    const vehiculos = listaComoItems(
        inf.vehiculos,
        (v) =>
            `<li>${valorODash(v.marca)} ${valorODash(v.modelo)} (${valorODash(v.dominio)}) - Color: ${valorODash(v.color)}</li>`,
        "Sin vehículos registrados"
    );
    const empleadores = listaComoItems(
        inf.empleadores,
        (e) =>
            `<li>${valorODash(e.nombre)} (CUIT: ${valorODash(e.cuit)}) - Alta: ${valorODash(e.alta)} - Baja: ${valorODash(e.baja)}</li>`,
        "Sin empleadores registrados"
    );
    const vinculos = listaComoItems(
        inf.vinculos,
        (v) =>
            `<li>${valorODash(v.nombre_apellido)} (DNI: ${valorODash(v.dni)}) - Tipo: ${valorODash(v.tipo)}</li>`,
        "Sin vínculos registrados"
    );
    const articulos = Array.isArray(inf.articulos) && inf.articulos.length
        ? inf.articulos
            .map(
                (a) =>
                    `<tr><td>${valorODash(a.titulo)}</td><td>${valorODash(a.categoria)}</td><td>${valorODash(a.fecha)}</td></tr>`
            )
            .join("")
        : "<tr><td colspan=\"3\" class=\"text-muted\">Sin artículos asociados</td></tr>";

    return `
        ${inf.foto ? `<img src="${inf.foto}" alt="Foto del informe" class="img-fluid mb-3" style="max-height: 300px;">` : ""}
        <div class="mb-2">
            <small class="text-muted">Última edición:</small>
            <span class="badge bg-info text-dark">${valorODash(inf.fecha_modificacion)}</span>
        </div>
        <p><strong>Generado por:</strong> ${valorODash(inf.generado_por)}</p>
        <p><strong>Fecha creación:</strong> ${valorODash(inf.fecha_creacion)}</p>
        <hr>
        <p><strong>Apellido:</strong> ${valorODash(inf.apellido)}</p>
        <p><strong>Nombre:</strong> ${valorODash(inf.nombre)}</p>
        <p><strong>Documento:</strong> ${valorODash(inf.documento)}</p>
        <p><strong>CUIT:</strong> ${valorODash(inf.cuit)}</p>
        <p><strong>Nacionalidad:</strong> ${valorODash(inf.nacionalidad)}</p>
        <p><strong>Sexo:</strong> ${sexo}</p>
        <p><strong>Banda:</strong> ${valorODash(inf.banda)}</p>
        <p><strong>Rol:</strong> ${valorODash(inf.rol)}</p>
        <p><strong>Situación:</strong> ${valorODash(inf.situacion)}</p>
        <p><strong>Actividad:</strong> ${valorODash(inf.actividad)}</p>
        <p><strong>Fecha nacimiento:</strong> ${valorODash(inf.fecha_nacimiento)}</p>
        <hr>
        <p><strong>Alias:</strong> ${aliasTexto}</p>
        <p><strong>Teléfonos:</strong> ${telefonosTexto}</p>
        <hr>
        <p><strong>Domicilios:</strong></p>
        <ul>${domicilios}</ul>
        <p><strong>Vehículos:</strong></p>
        <ul>${vehiculos}</ul>
        <p><strong>Empleadores:</strong></p>
        <ul>${empleadores}</ul>
        <p><strong>Vínculos:</strong></p>
        <ul>${vinculos}</ul>
        <hr>
        <p><strong>Artículos Asociados:</strong></p>
        <table class="table table-sm">
            <thead><tr><th>Título</th><th>Categoría</th><th>Fecha</th></tr></thead>
            <tbody>${articulos}</tbody>
        </table>
    `;
}

function listaEnTexto(valores, textoVacio) {
    if (Array.isArray(valores) && valores.length) {
        return valores.join(", ");
    }
    return textoVacio;
}

function listaComoItems(valores, formateador, textoVacio) {
    if (Array.isArray(valores) && valores.length) {
        return valores.map(formateador).join("");
    }
    return `<li class="text-muted">${textoVacio}</li>`;
}

function valorODash(valor) {
    return valor ? valor : "-";
}

function capitalizarTexto(texto) {
    if (!texto || typeof texto !== "string") {
        return "";
    }
    return texto.charAt(0).toUpperCase() + texto.slice(1);
}

async function cargarCategoriaBandas() {
    if (categoriaBandasId) {
        return;
    }
    try {
        const res = await fetch("/api/categorias/");
        const categorias = await res.json();
        const categoria = categorias.find(cat => normalizarTexto(cat.nombre) === CATEGORIA_BANDAS);
        if (categoria) {
            categoriaBandasId = categoria.id;
        } else {
            console.warn("No se encontró la categoría 'bandas criminales'.");
        }
    } catch (error) {
        console.error("Error cargando categorías:", error);
    }
}

async function cargarDiariosBandas() {
    try {
        const res = await fetch("/api/diarios/");
        diariosBandas = await res.json();
        const select = document.getElementById("bandas_filtro_diario");
        if (select) {
            select.innerHTML = '<option value="">Todos</option>';
            diariosBandas.forEach(diario => select.add(new Option(diario.nombre, diario.id)));
        }
    } catch (error) {
        console.error("Error cargando diarios:", error);
    }
}

async function cargarRedesBandas() {
    try {
        const res = await fetch("/api/redes/");
        redesBandas = await res.json();
        const select = document.getElementById("bandas_filtro_red");
        if (select) {
            select.innerHTML = '<option value="">Todas</option>';
            redesBandas.forEach(red => select.add(new Option(red.nombre, red.id)));
        }
    } catch (error) {
        console.error("Error cargando redes sociales:", error);
    }
}

function actualizarCamposFuenteBandas() {
    const origen = document.getElementById("bandas_origen");
    const grupoDiario = document.getElementById("bandas-grupo-diario");
    const grupoRed = document.getElementById("bandas-grupo-red");
    const valor = origen ? origen.value : "diario";
    if (grupoDiario) {
        grupoDiario.classList.toggle("d-none", valor !== "diario");
    }
    if (grupoRed) {
        grupoRed.classList.toggle("d-none", valor !== "red_social");
    }
}

function inicializarSeleccionLinksBandas() {
    linksBandasSeleccionadosDiario = parsearListaLinksSeleccionados("id_links_diarios");
    linksBandasSeleccionadosRed = parsearListaLinksSeleccionados("id_links_redes");
    linksBandasSeleccionadosDiario.forEach((id) => linksRevisadosBandas.add(id));
    linksBandasSeleccionadosRed.forEach((id) => linksRevisadosBandas.add(id));
    actualizarCamposLinksSeleccionados();
}

function parsearListaLinksSeleccionados(idCampo) {
    const input = document.getElementById(idCampo);
    if (!input || !input.value) {
        return [];
    }
    try {
        const data = JSON.parse(input.value);
        if (Array.isArray(data)) {
            return data.map((valor) => parseInt(valor, 10)).filter((valor) => !Number.isNaN(valor));
        }
    } catch (error) {
        console.warn("No se pudo interpretar la selección previa de links:", error);
    }
    return [];
}

function actualizarCamposLinksSeleccionados() {
    const inputDiario = document.getElementById("id_links_diarios");
    const inputRed = document.getElementById("id_links_redes");
    if (inputDiario) {
        inputDiario.value = JSON.stringify(linksBandasSeleccionadosDiario);
    }
    if (inputRed) {
        inputRed.value = JSON.stringify(linksBandasSeleccionadosRed);
    }
}

async function marcarLinkBandaRevisado(id, tipoFuente = "diario") {
    const endpoint = obtenerEndpointPorFuenteBandas(tipoFuente);
    try {
        const resp = await fetch(`${endpoint}${id}/`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
            body: JSON.stringify({ revisado_redactor: true }),
        });
        if (!resp.ok) {
            throw new Error(`No se pudo marcar el link (HTTP ${resp.status})`);
        }
        linksRevisadosBandas.add(id);
        const link = linksBandasGlobal.find((item) => item.id === id);
        if (link) {
            link.revisado_redactor = true;
        }
        setTimeout(() => {
            mostrarLinksBandasPagina(linksBandasGlobal, paginaLinksBandasActual);
        }, 200);
    } catch (error) {
        console.error("Error al marcar el link como revisado:", error);
    }
}

function toggleSeleccionLinkBanda(id, tipo, checked) {
    const numericId = parseInt(id, 10);
    if (Number.isNaN(numericId)) {
        return;
    }
    const esRed = tipo === "red_social";
    const arrayObjetivo = esRed ? linksBandasSeleccionadosRed : linksBandasSeleccionadosDiario;
    const indice = arrayObjetivo.indexOf(numericId);
    if (checked && indice === -1) {
        arrayObjetivo.push(numericId);
    } else if (!checked && indice !== -1) {
        arrayObjetivo.splice(indice, 1);
    }
    if (esRed) {
        linksBandasSeleccionadosRed = arrayObjetivo;
    } else {
        linksBandasSeleccionadosDiario = arrayObjetivo;
    }
    actualizarCamposLinksSeleccionados();
}

function linkBandaEstaSeleccionado(tipo, id) {
    const numericId = parseInt(id, 10);
    if (Number.isNaN(numericId)) {
        return false;
    }
    const arrayObjetivo = tipo === "red_social" ? linksBandasSeleccionadosRed : linksBandasSeleccionadosDiario;
    return arrayObjetivo.includes(numericId);
}

async function cargarLinksBandas() {
    const tbody = document.querySelector("#tabla-links-bandas tbody");
    const paginacion = document.getElementById("paginacion-links-bandas");
    if (!tbody) {
        return;
    }
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Cargando links aprobados...</td></tr>`;
    if (paginacion) {
        paginacion.classList.add("d-none");
    }

    if (!categoriaBandasId) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">No se pudo determinar la categoría Bandas criminales.</td></tr>`;
        return;
    }

    const desde = document.getElementById("bandas_fecha_desde")?.value;
    const hasta = document.getElementById("bandas_fecha_hasta")?.value;
    const origen = document.getElementById("bandas_origen")?.value || "diario";
    const diario = document.getElementById("bandas_filtro_diario")?.value;
    const red = document.getElementById("bandas_filtro_red")?.value;

    let url = "/api/links_list/";
    const params = [];
    if (desde) params.push(`fecha_inicio=${desde}`);
    if (hasta) params.push(`fecha_fin=${hasta}`);
    if (origen) params.push(`fuente=${origen}`);
    if (origen === "diario" && diario) params.push(`diario_id=${diario}`);
    if (origen === "red_social" && red) params.push(`red_social_id=${red}`);
    params.push(`categoria_id=${categoriaBandasId}`);
    params.push(`estado=aprobado`);

    if (params.length) {
        url += `?${params.join("&")}`;
    }

    try {
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error(`Error HTTP ${res.status}`);
        }
        const links = await res.json();
        linksBandasGlobal = links
            .filter(link => link.estado === "aprobado")
            .sort((a, b) => {
                const fechaA = a.fecha_carga ? new Date(a.fecha_carga).getTime() : 0;
                const fechaB = b.fecha_carga ? new Date(b.fecha_carga).getTime() : 0;
                return fechaB - fechaA;
            });

        if (!linksBandasGlobal.length) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No se encontraron links aprobados para los filtros seleccionados.</td></tr>`;
            return;
        }

        paginaLinksBandasActual = 1;
        mostrarLinksBandasPagina(linksBandasGlobal, paginaLinksBandasActual);
    } catch (error) {
        console.error("Error cargando links:", error);
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error al cargar los links: ${error.message}</td></tr>`;
    }
}

function mostrarLinksBandasPagina(links, pagina) {
    const tbody = document.querySelector("#tabla-links-bandas tbody");
    if (!tbody) {
        return;
    }
    tbody.innerHTML = "";

    const inicio = (pagina - 1) * LINKS_BANDAS_POR_PAGINA;
    const paginaLinks = links.slice(inicio, inicio + LINKS_BANDAS_POR_PAGINA);

    if (!paginaLinks.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No se encontraron links para mostrar.</td></tr>`;
        actualizarPaginacionLinksBandas(0, 0);
        return;
    }

    paginaLinks.forEach(link => {
        const tipoFuente = link.tipo_fuente || "diario";
        const logoUrl = link.diario_logo_url || link.red_social_logo_url || link.tv_digital_logo_url || link.radio_digital_logo_url || '/static/img/default_logo.png';
        const fuenteNombre = link.diario_nombre || link.red_social_nombre || link.tv_digital_nombre || link.radio_digital_nombre || "Sin fuente";
        const tipoLabel = formatearTipoFuenteBandas(tipoFuente);
        const badgeTipo = tipoLabel ? `<span class="badge bg-light text-dark border ms-2">${tipoLabel}</span>` : "";
        const badgeIA = link.clasificado_por_ia ? '<span class="badge bg-info ms-2">IA</span>' : "";
        const fecha = link.fecha_carga ? new Date(link.fecha_carga).toLocaleDateString() : "-";
        const categorias = link.categorias_info && link.categorias_info.length
            ? link.categorias_info.map(cat => `<span class="badge bg-secondary me-1">${cat.nombre}</span>`).join("")
            : "-";
        const asociadosHtml = Array.isArray(link.asociados) && link.asociados.length
            ? link.asociados.map(a => `<div>#${a.id} - ${escapeHtml(String(a.titulo || "Sin título"))}</div>`).join("")
            : "<span class='text-muted'>Sin asociar</span>";

        const linkUrl = link.url || "";
        const textoLink = linkUrl
            ? (linkUrl.length > 60 ? linkUrl.slice(0, 60) + "…" : linkUrl)
            : "Sin URL";
        const revisadoBackend = Boolean(link.revisado_redactor);
        if (revisadoBackend) {
            linksRevisadosBandas.add(link.id);
        }
        const revisado = revisadoBackend || linksRevisadosBandas.has(link.id);
        const disabled = revisado ? "" : "disabled";
        const badgeRevisado = revisado ? "✔" : "";
        const checked = linkBandaEstaSeleccionado(tipoFuente, link.id) ? "checked" : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><img src="${logoUrl}" alt="Logo fuente" style="height:40px; max-width:60px"></td>
            <td>${fuenteNombre}${badgeTipo}${badgeIA}</td>
            <td>${linkUrl ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer" onclick="marcarLinkBandaRevisado(${link.id}, '${tipoFuente}')">${textoLink}</a>` : '<span class="text-muted">Sin URL</span>'}</td>
            <td>${fecha}</td>
            <td>${categorias}</td>
            <td>${asociadosHtml}</td>
            <td><span class="badge ${revisado ? 'bg-success' : 'bg-secondary'}">${badgeRevisado || 'Pendiente'}</span></td>
            <td>
                <input type="checkbox"
                    class="form-check-input"
                    onchange="toggleSeleccionLinkBanda(${link.id}, '${tipoFuente}', this.checked)"
                    ${checked}
                    ${disabled}>
            </td>
        `;
        tbody.appendChild(tr);
    });

    const totalPaginas = Math.ceil(links.length / LINKS_BANDAS_POR_PAGINA);
    actualizarPaginacionLinksBandas(totalPaginas, pagina);
}

function actualizarPaginacionLinksBandas(totalPaginas, paginaActual) {
    const paginacion = document.getElementById("paginacion-links-bandas");
    if (!paginacion) {
        return;
    }
    const ul = paginacion.querySelector("ul");
    if (!ul) {
        return;
    }
    ul.innerHTML = "";

    if (totalPaginas <= 1) {
        paginacion.classList.add("d-none");
        return;
    }

    paginacion.classList.remove("d-none");

    const liPrev = document.createElement("li");
    liPrev.className = `page-item ${paginaActual === 1 ? "disabled" : ""}`;
    liPrev.innerHTML = `<a class="page-link" role="button" onclick="cambiarPaginaLinksBandas(${paginaActual - 1})">Anterior</a>`;
    ul.appendChild(liPrev);

    for (let i = 1; i <= totalPaginas; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === paginaActual ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" role="button" onclick="cambiarPaginaLinksBandas(${i})">${i}</a>`;
        ul.appendChild(li);
    }

    const liNext = document.createElement("li");
    liNext.className = `page-item ${paginaActual === totalPaginas ? "disabled" : ""}`;
    liNext.innerHTML = `<a class="page-link" role="button" onclick="cambiarPaginaLinksBandas(${paginaActual + 1})">Siguiente</a>`;
    ul.appendChild(liNext);
}

function cambiarPaginaLinksBandas(nuevaPagina) {
    if (nuevaPagina < 1 || nuevaPagina === paginaLinksBandasActual) {
        return;
    }
    const totalPaginas = Math.ceil(linksBandasGlobal.length / LINKS_BANDAS_POR_PAGINA);
    if (nuevaPagina > totalPaginas) {
        return;
    }
    paginaLinksBandasActual = nuevaPagina;
    mostrarLinksBandasPagina(linksBandasGlobal, paginaLinksBandasActual);
}

function formatearTipoFuenteBandas(tipo) {
    const etiquetas = {
        diario: "Diario digital",
        red_social: "Red social",
        tv_digital: "TV digital",
        radio_digital: "Radio digital",
    };
    return etiquetas[tipo] || "";
}

function obtenerEndpointPorFuenteBandas(tipo) {
    const base = {
        diario: "/api/links/",
        red_social: "/api/links_red_social/",
        tv_digital: "/api/links_tv_digital/",
        radio_digital: "/api/links_radio_digital/",
    };
    return base[tipo] || "/api/links/";
}


function inicializarCamposAlias() {
    const hiddenField = document.getElementById("id_alias");
    const listContainer = document.getElementById("alias-dynamic-list");
    const addButton = document.getElementById("btn-agregar-alias");

    if (!hiddenField || !listContainer || !addButton) {
        return;
    }

    const crearFila = (valor = "") => {
        const wrapper = document.createElement("div");
        wrapper.className = "input-group";

        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control";
        input.placeholder = "Alias o denominación alternativa";
        input.value = valor || "";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-danger btn-remove-alias";
        btn.textContent = "Quitar";

        wrapper.appendChild(input);
        wrapper.appendChild(btn);
        listContainer.appendChild(wrapper);
    };

    const sincronizarHidden = () => {
        const valores = [];
        listContainer.querySelectorAll("input").forEach((input) => {
            const valor = input.value.trim();
            if (valor) {
                valores.push(valor);
            }
        });
        hiddenField.value = JSON.stringify(valores);
    };

    addButton.addEventListener("click", () => {
        crearFila("");
        sincronizarHidden();
    });

    listContainer.addEventListener("input", sincronizarHidden);

    listContainer.addEventListener("click", (event) => {
        if (event.target.matches(".btn-remove-alias")) {
            const wrapper = event.target.closest(".input-group");
            if (wrapper) {
                wrapper.remove();
                if (listContainer.querySelectorAll(".input-group").length === 0) {
                    crearFila("");
                }
                sincronizarHidden();
            }
        }
    });

    try {
        const iniciales = JSON.parse(hiddenField.value || "[]");
        if (Array.isArray(iniciales) && iniciales.length) {
            iniciales.forEach((alias) => crearFila(alias));
        } else {
            crearFila("");
        }
    } catch (error) {
        crearFila("");
    }

    sincronizarHidden();
}

function inicializarZonasInfluencia() {
    const hiddenField = document.getElementById("id_zonas_influencia");
    const listContainer = document.getElementById("zonas-dynamic-list");
    const addButton = document.getElementById("btn-agregar-zona");

    if (!hiddenField || !listContainer || !addButton) {
        return;
    }

    const crearZona = (data = {}) => {
        const wrapper = document.createElement("div");
        wrapper.className = "border rounded p-3 zona-item";

        const row1 = document.createElement("div");
        row1.className = "row g-2";

        const colBarrio = document.createElement("div");
        colBarrio.className = "col-md-3";
        const inputBarrio = document.createElement("input");
        inputBarrio.type = "text";
        inputBarrio.className = "form-control";
        inputBarrio.placeholder = "Barrio";
        inputBarrio.value = data.barrio || "";
        colBarrio.appendChild(inputBarrio);

        const colLocalidad = document.createElement("div");
        colLocalidad.className = "col-md-3";
        const inputLocalidad = document.createElement("input");
        inputLocalidad.type = "text";
        inputLocalidad.className = "form-control";
        inputLocalidad.placeholder = "Localidad";
        inputLocalidad.value = data.localidad || "";
        colLocalidad.appendChild(inputLocalidad);

        const colCiudad = document.createElement("div");
        colCiudad.className = "col-md-3";
        const inputCiudad = document.createElement("input");
        inputCiudad.type = "text";
        inputCiudad.className = "form-control";
        inputCiudad.placeholder = "Ciudad";
        inputCiudad.value = data.ciudad || "";
        colCiudad.appendChild(inputCiudad);

        const colProvincia = document.createElement("div");
        colProvincia.className = "col-md-3";
        const inputProvincia = document.createElement("input");
        inputProvincia.type = "text";
        inputProvincia.className = "form-control";
        inputProvincia.placeholder = "Provincia";
        inputProvincia.value = data.provincia || "";
        colProvincia.appendChild(inputProvincia);

        row1.appendChild(colBarrio);
        row1.appendChild(colLocalidad);
        row1.appendChild(colCiudad);
        row1.appendChild(colProvincia);

        const actions = document.createElement("div");
        actions.className = "text-end mt-2";

        const btnRemove = document.createElement("button");
        btnRemove.type = "button";
        btnRemove.className = "btn btn-sm btn-outline-danger btn-remove-zona";
        btnRemove.textContent = "Quitar zona";
        actions.appendChild(btnRemove);

        wrapper.appendChild(row1);
        wrapper.appendChild(actions);

        listContainer.appendChild(wrapper);
    };

    const sincronizarHidden = () => {
        const zonas = [];
        listContainer.querySelectorAll(".zona-item").forEach((zona) => {
            const inputs = zona.querySelectorAll("input");
            const [barrio, localidad, ciudad, provincia] = Array.from(inputs).map((input) =>
                input.value.trim()
            );
            if (barrio || localidad || ciudad || provincia) {
                zonas.push({ barrio, localidad, ciudad, provincia });
            }
        });
        hiddenField.value = JSON.stringify(zonas);
    };

    addButton.addEventListener("click", () => {
        crearZona();
        sincronizarHidden();
    });

    listContainer.addEventListener("input", () => {
        sincronizarHidden();
    });

    listContainer.addEventListener("click", (event) => {
        if (event.target.matches(".btn-remove-zona")) {
            const zona = event.target.closest(".zona-item");
            if (zona) {
                zona.remove();
                if (listContainer.querySelectorAll(".zona-item").length === 0) {
                    crearZona();
                }
                sincronizarHidden();
            }
        }
    });

    try {
        const zonasIniciales = JSON.parse(hiddenField.value || "[]");
        if (Array.isArray(zonasIniciales) && zonasIniciales.length) {
            zonasIniciales.forEach((zona) => crearZona(zona));
        } else {
            crearZona();
        }
    } catch (error) {
        crearZona();
    }

    sincronizarHidden();
}

function filtrarBandasSelect(selectId, filtro) {
    const select = document.getElementById(selectId);
    if (!select) {
        return;
    }
    const texto = (filtro || "").toLowerCase();
    Array.from(select.options).forEach((option) => {
        if (!texto) {
            option.hidden = false;
        } else {
            option.hidden = option.textContent.toLowerCase().indexOf(texto) === -1;
        }
    });
}

function normalizarTexto(texto) {
    return (texto || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(str) {
    if (str === null || str === undefined) {
        return "";
    }
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}
</script>
{% endblock %}
