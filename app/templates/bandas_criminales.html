{% extends 'base.html' %}
{% block title %}Bandas Criminales{% endblock %}

{% block content %}
<h1 class="mb-4">Bandas Criminales</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}

<div class="row">
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                {% if modo_edicion %}
                    Editar banda criminal
                {% else %}
                    Nueva banda criminal
                {% endif %}
            </div>
            <div class="card-body">
                {% if modo_edicion and banda_actual %}
                    <div class="alert alert-info py-2">
                        Estás editando <strong>{{ banda_actual.nombres_como_texto }}</strong>.
                    </div>
                {% endif %}
                <form method="post" action="{{ form_action|default:request.path }}">
                    {% csrf_token %}
                    {% for field in form %}
                        {% if field.name == "nombres" %}
                            <div class="mb-3">
                                <label class="form-label" for="id_nombres_control">Nombres o alias</label>
                                {{ field }}
                                <div id="nombres-dynamic-list" class="d-flex flex-column gap-2"></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btn-agregar-nombre">
                                    Agregar otro nombre
                                </button>
                                <div class="form-text">
                                    Cargá uno o más nombres/alias para esta banda. Podés agregar y quitar campos con los botones.
                                </div>
                                {% if field.errors %}
                                    <div class="text-danger small mt-2">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% elif field.name == "zonas_influencia" %}
                            <div class="mb-3">
                                <label class="form-label" for="id_zonas_control">Zonas de influencia</label>
                                {{ field }}
                                <div id="zonas-dynamic-list" class="d-flex flex-column gap-3"></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btn-agregar-zona">
                                    Agregar zona
                                </button>
                                <div class="form-text">
                                    Definí una o varias zonas indicando barrio, localidad, ciudad y provincia. Podés dejar vacíos los campos que no correspondan.
                                </div>
                                {% if field.errors %}
                                    <div class="text-danger small mt-2">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="mb-3">
                                {{ field.label_tag }}
                                {{ field }}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="text-danger small">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            {% if modo_edicion %}Guardar cambios{% else %}Crear banda{% endif %}
                        </button>
                        {% if modo_edicion %}
                            <a href="{% url 'bandas_criminales' %}" class="btn btn-secondary">Cancelar</a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">Filtrar bandas criminales</div>
            <div class="card-body">
                <form method="get" action="" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="filtro-nombre">Nombre o alias</label>
                        <input
                            type="text"
                            class="form-control"
                            id="filtro-nombre"
                            name="nombre"
                            value="{{ filtros.nombre }}"
                            placeholder="Ej: sapucai"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="filtro-zona">Zona de influencia</label>
                        <input
                            type="text"
                            class="form-control"
                            id="filtro-zona"
                            name="zona"
                            value="{{ filtros.zona }}"
                            placeholder="Barrio, ciudad o provincia"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="filtro-aliada">Banda aliada</label>
                        <input
                            type="text"
                            class="form-control"
                            id="filtro-aliada"
                            name="aliada"
                            value="{{ filtros.aliada }}"
                            placeholder="Nombre de banda aliada"
                        >
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="filtro-rival">Banda rival</label>
                        <input
                            type="text"
                            class="form-control"
                            id="filtro-rival"
                            name="rival"
                            value="{{ filtros.rival }}"
                            placeholder="Nombre de banda rival"
                        >
                    </div>
                    <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Aplicar filtros</button>
                        <a href="{% url 'bandas_criminales' %}" class="btn btn-outline-secondary">Limpiar</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Listado de bandas criminales</div>
            <div class="card-body p-0">
                {% if bandas %}
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Nombres / Alias</th>
                                    <th>Zonas de influencia</th>
                                    <th>Líderes</th>
                                    <th>Miembros</th>
                                    <th>Bandas aliadas</th>
                                    <th>Bandas rivales</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for banda in bandas %}
                                <tr {% if banda_actual and banda.pk == banda_actual.pk %}class="table-info"{% endif %}>
                                    <td>
                                        {% if banda.nombres %}
                                            {% for alias in banda.nombres %}
                                                <span class="badge bg-light text-dark border">{{ alias }}</span>{% if not forloop.last %} {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">Sin nombre</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if banda.zonas_influencia_detalle %}
                                            <ul class="mb-0 ps-3">
                                                {% for zona in banda.zonas_influencia_detalle %}
                                                    <li>
                                                        {% if zona.barrio %}<strong>Barrio:</strong> {{ zona.barrio }}{% endif %}
                                                        {% if zona.localidad %}{% if zona.barrio %} · {% endif %}<strong>Localidad:</strong> {{ zona.localidad }}{% endif %}
                                                        {% if zona.ciudad %}{% if zona.barrio or zona.localidad %} · {% endif %}<strong>Ciudad:</strong> {{ zona.ciudad }}{% endif %}
                                                        {% if zona.provincia %}{% if zona.barrio or zona.localidad or zona.ciudad %} · {% endif %}<strong>Provincia:</strong> {{ zona.provincia }}{% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <span class="text-muted">Sin zonas registradas</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% with lideres=banda.lideres.all %}
                                            {% if lideres %}
                                                {% for lider in lideres %}
                                                    {{ lider }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">Sin líderes</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% with miembros=banda.miembros.all %}
                                            {% if miembros %}
                                                {% for miembro in miembros %}
                                                    {{ miembro }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">Sin miembros</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% with aliadas=banda.bandas_aliadas.all %}
                                            {% if aliadas %}
                                                <ul class="mb-0 ps-3">
                                                    {% for aliada in aliadas %}
                                                        <li>{{ aliada.nombre_principal|default:aliada }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <span class="text-muted">Sin alianzas registradas</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% with rivales=banda.bandas_rivales.all %}
                                            {% if rivales %}
                                                <ul class="mb-0 ps-3">
                                                    {% for rival in rivales %}
                                                        <li>{{ rival.nombre_principal|default:rival }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <span class="text-muted">Sin rivales registrados</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td class="text-end">
                                        <a href="{% url 'banda_criminal_editar' banda.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
                                        <form method="post" action="{% url 'banda_criminal_eliminar' banda.pk %}" class="d-inline form-eliminar-banda">
                                            {% csrf_token %}
                                            <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-banda">Eliminar</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="mb-0 text-muted p-3">Todavía no hay bandas registradas.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    inicializarCamposNombres();
    inicializarZonasInfluencia();

    document.querySelectorAll(".form-eliminar-banda").forEach(function (form) {
        const btn = form.querySelector(".btn-eliminar-banda");
        if (!btn) {
            return;
        }
        btn.addEventListener("click", function (event) {
            event.preventDefault();
            Swal.fire({
                title: "¿Eliminar banda criminal?",
                text: "Esta acción no se puede deshacer.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#6c757d",
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "Cancelar",
            }).then(function (result) {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
});

function inicializarCamposNombres() {
    const hiddenField = document.getElementById("id_nombres");
    const listContainer = document.getElementById("nombres-dynamic-list");
    const addButton = document.getElementById("btn-agregar-nombre");

    if (!hiddenField || !listContainer || !addButton) {
        return;
    }

    const crearFila = (valor = "") => {
        const wrapper = document.createElement("div");
        wrapper.className = "input-group";

        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-control";
        input.placeholder = "Alias o denominación";
        input.value = valor || "";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-outline-danger btn-remove-nombre";
        btn.textContent = "Quitar";

        wrapper.appendChild(input);
        wrapper.appendChild(btn);
        listContainer.appendChild(wrapper);
    };

    const sincronizarHidden = () => {
        const valores = [];
        listContainer.querySelectorAll("input").forEach((input) => {
            const valor = input.value.trim();
            if (valor) {
                valores.push(valor);
            }
        });
        hiddenField.value = JSON.stringify(valores);
    };

    addButton.addEventListener("click", () => {
        crearFila("");
        sincronizarHidden();
    });

    listContainer.addEventListener("input", () => {
        sincronizarHidden();
    });

    listContainer.addEventListener("click", (event) => {
        if (event.target.matches(".btn-remove-nombre")) {
            const wrapper = event.target.closest(".input-group");
            if (wrapper) {
                wrapper.remove();
                if (listContainer.querySelectorAll(".input-group").length === 0) {
                    crearFila("");
                }
                sincronizarHidden();
            }
        }
    });

    try {
        const iniciales = JSON.parse(hiddenField.value || "[]");
        if (Array.isArray(iniciales) && iniciales.length) {
            iniciales.forEach((nombre) => crearFila(nombre));
        } else {
            crearFila("");
        }
    } catch (error) {
        crearFila("");
    }

    sincronizarHidden();
}

function inicializarZonasInfluencia() {
    const hiddenField = document.getElementById("id_zonas_influencia");
    const listContainer = document.getElementById("zonas-dynamic-list");
    const addButton = document.getElementById("btn-agregar-zona");

    if (!hiddenField || !listContainer || !addButton) {
        return;
    }

    const crearZona = (data = {}) => {
        const wrapper = document.createElement("div");
        wrapper.className = "border rounded p-3 zona-item";

        const row1 = document.createElement("div");
        row1.className = "row g-2";

        const colBarrio = document.createElement("div");
        colBarrio.className = "col-md-3";
        const inputBarrio = document.createElement("input");
        inputBarrio.type = "text";
        inputBarrio.className = "form-control";
        inputBarrio.placeholder = "Barrio";
        inputBarrio.value = data.barrio || "";
        colBarrio.appendChild(inputBarrio);

        const colLocalidad = document.createElement("div");
        colLocalidad.className = "col-md-3";
        const inputLocalidad = document.createElement("input");
        inputLocalidad.type = "text";
        inputLocalidad.className = "form-control";
        inputLocalidad.placeholder = "Localidad";
        inputLocalidad.value = data.localidad || "";
        colLocalidad.appendChild(inputLocalidad);

        const colCiudad = document.createElement("div");
        colCiudad.className = "col-md-3";
        const inputCiudad = document.createElement("input");
        inputCiudad.type = "text";
        inputCiudad.className = "form-control";
        inputCiudad.placeholder = "Ciudad";
        inputCiudad.value = data.ciudad || "";
        colCiudad.appendChild(inputCiudad);

        const colProvincia = document.createElement("div");
        colProvincia.className = "col-md-3";
        const inputProvincia = document.createElement("input");
        inputProvincia.type = "text";
        inputProvincia.className = "form-control";
        inputProvincia.placeholder = "Provincia";
        inputProvincia.value = data.provincia || "";
        colProvincia.appendChild(inputProvincia);

        row1.appendChild(colBarrio);
        row1.appendChild(colLocalidad);
        row1.appendChild(colCiudad);
        row1.appendChild(colProvincia);

        const actions = document.createElement("div");
        actions.className = "text-end mt-2";

        const btnRemove = document.createElement("button");
        btnRemove.type = "button";
        btnRemove.className = "btn btn-sm btn-outline-danger btn-remove-zona";
        btnRemove.textContent = "Quitar zona";
        actions.appendChild(btnRemove);

        wrapper.appendChild(row1);
        wrapper.appendChild(actions);

        listContainer.appendChild(wrapper);
    };

    const sincronizarHidden = () => {
        const zonas = [];
        listContainer.querySelectorAll(".zona-item").forEach((zona) => {
            const inputs = zona.querySelectorAll("input");
            const [barrio, localidad, ciudad, provincia] = Array.from(inputs).map((input) =>
                input.value.trim()
            );
            if (barrio || localidad || ciudad || provincia) {
                zonas.push({ barrio, localidad, ciudad, provincia });
            }
        });
        hiddenField.value = JSON.stringify(zonas);
    };

    addButton.addEventListener("click", () => {
        crearZona();
        sincronizarHidden();
    });

    listContainer.addEventListener("input", () => {
        sincronizarHidden();
    });

    listContainer.addEventListener("click", (event) => {
        if (event.target.matches(".btn-remove-zona")) {
            const zona = event.target.closest(".zona-item");
            if (zona) {
                zona.remove();
                if (listContainer.querySelectorAll(".zona-item").length === 0) {
                    crearZona();
                }
                sincronizarHidden();
            }
        }
    });

    try {
        const zonasIniciales = JSON.parse(hiddenField.value || "[]");
        if (Array.isArray(zonasIniciales) && zonasIniciales.length) {
            zonasIniciales.forEach((zona) => crearZona(zona));
        } else {
            crearZona();
        }
    } catch (error) {
        crearZona();
    }

    sincronizarHidden();
}
</script>
{% endblock %}
